<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BookStack</title>
    <style>
        /* RESET & VIEWPORT */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: sans-serif;
            background: #ffffff;
            color: #000000;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            /* CRITICAL: No scroll */
            display: flex;
            flex-direction: column;
            font-size: 20px;
        }

        /* LAYOUT CONTAINERS */
        #top-nav {
            height: 45px;
            border-bottom: 2px solid #000;
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-shrink: 0;
            background: #fff;
        }

        #context-bar {
            height: 45px;
            border-bottom: 2px solid #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 5px;
            flex-shrink: 0;
            background: #fff;
        }

        #content-area {
            flex-grow: 1;
            overflow: hidden;
            /* Hide overflow, use pagination */
            padding: 5px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            /* Items start at top */
        }

        /* NAVIGATION LINKS */
        .nav-link {
            text-decoration: none;
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
            box-sizing: border-box;
            font-size: 24px;
        }

        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 21px;
            text-transform: uppercase;
        }

        .book-card {
            background: #fff;
            border: 1px solid #000;
            padding: 15px;
            margin-bottom: 10px;
            font-size: 24px;
        }

        .btn {
            background: #000;
            color: #fff;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-size: 24px;
            width: 100%;
            font-weight: bold;
        }

        .queue-item {
            background: #fff;
            border: 1px solid #000;
            padding: 10px;
            margin-bottom: 5px;
            font-size: 24px;
        }

        .hidden {
            display: none;
        }

        #message-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            margin-left: -100px;
            background: #333;
            color: #fff;
            padding: 10px 20px;
            width: 200px;
            text-align: center;
            font-size: 24px;
        }

        .opds-item {
            background: #fff;
            border: 1px solid #000;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            font-size: 24px;
        }

        .opds-item:hover {
            background: #f5f5f5;
        }

        .book-row {
            display: table;
            width: 100%;
        }

        .book-cover {
            display: table-cell;
            width: 140px;
            vertical-align: top;
            padding-right: 15px;
        }

        .book-cover img {
            width: 140px;
            height: 210px;
            border: 1px solid #ccc;
            object-fit: cover;
            display: block;
            margin-bottom: 10px;
        }

        .book-info {
            display: table-cell;
            vertical-align: top;
        }

        .book-description {
            margin-top: 8px;
            color: #555;
            font-size: 21px;
            line-height: 1.4;
        }

        p {
            font-size: 24px;
            line-height: 1.4;
        }

        .section-header {
            font-size: 30px;
            font-weight: bold;
            padding: 15px 0;
        }

        small {
            font-size: 21px;
        }
    </style>
    .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: none;
    }

    .modal-content {
    background: #fff;
    margin: 10% auto;
    padding: 20px;
    width: 80%;
    max-width: 600px;
    border: 2px solid #000;
    max-height: 80vh;
    overflow-y: auto;
    font-size: 20px;
    }
    </style>
</head>

<body>
    <div id="desc-modal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div id="modal-text"></div>
            <br>
            <button class="btn" onclick="closeModal()">Close</button>
        </div>
    </div>


    <div class="nav">
        <a href="#" id="tab-cloud-btn" class="active" onclick="switchTab('cloud'); return false;">Library</a>
        <a href="#" id="tab-search-btn" onclick="switchTab('search'); return false;">Request</a>
        <a href="#" id="tab-queue-btn" onclick="switchTab('queue'); return false;">Queue</a>
        <a href="#" id="tab-settings-btn" onclick="switchTab('settings'); return false;">...</a>
    </div>

    <div class="container">
        <div id="view-cloud">
            <div id="opds-content"></div>
        </div>

        <div id="view-search" class="hidden">
            <div id="search-menu"></div>
            <div id="ephemera-search" class="hidden">
                <div class="card" id="search-input-card">
                    <p style="margin-top:0; color:#666;">Search for a book to add to the Cloud Library</p>
                    <input type="text" id="search-input" placeholder="Search Ephemera...">
                    <button class="btn" onclick="performSearch()">Search</button>
                </div>
                <div id="search-results"></div>
            </div>
            <div id="bsio-search-container" class="hidden"></div>
            <div id="releases-container" class="hidden"></div>
        </div>

        <div id="view-queue" class="hidden">
            <p style="margin:0 0 15px 0; color:#666;">Requested books will appear in the cloud library when marked as
                complete below</p>
            <div id="queue-list"></div>
        </div>

        <div id="view-settings" class="hidden">
            <div class="card">
                <label>Send to Kindle Email</label>
                <input type="email" id="kindle-email" placeholder="username@kindle.com">
                <button class="btn" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <div id="message-toast" class="hidden"></div>

    <script>
        var currentTab = 'cloud';
        var opdsHistory = [];
        var opdsData = [];

        // Pagination State
        var paginationState = {
            items: [],
            currentPage: 0,
            pageSize: 10, // Default, will be calculated
            title: '',
            backAction: null,
            itemRenderer: null
        };
        var searchStateBackup = null; // Backup for search results state

        function calculatePageSize() {
            // Measure available height in content-area
            var container = document.getElementById('content-area');
            var style = window.getComputedStyle(container);
            var height = container.clientHeight - parseFloat(style.paddingTop) - parseFloat(style.paddingBottom);

            // Assume min height for an item (safety fallback)
            // Ideally we measure one, but for first render we guess.
            // Book item is approx 120px + margins. List item approx 60px.
            // Let's go conservative.
            // Better strategy: Use fixed row heights defined in CSS (max-height: 140px).
            // So:
            var itemHeight = 150; // 140px max-height + 10px margins

            var size = Math.floor(height / itemHeight);
            return Math.max(1, size); // At least 1 item
        }

        function updateContextBar() {
            var left = document.getElementById('ctx-left');
            var center = document.getElementById('ctx-center');
            var right = document.getElementById('ctx-right');

            left.innerHTML = '';
            center.innerHTML = '';
            right.innerHTML = '';

            // Title
            center.innerText = paginationState.title || 'BookStack';

            // Back Button
            if (paginationState.backAction) {
                var btn = document.createElement('button');
                btn.className = 'btn';
                btn.innerHTML = '&lt; BACK';
                btn.onclick = paginationState.backAction;
                left.appendChild(btn);
            }

            // Pagination Controls
            var totalPages = Math.ceil(paginationState.items.length / paginationState.pageSize);
            if (totalPages > 1) {
                // We put page info in center or right?
                // Center: Title (1/5)
                center.innerText += ' (' + (paginationState.currentPage + 1) + '/' + totalPages + ')';

                var prev = document.createElement('button');
                prev.className = 'btn';
                prev.innerHTML = '&lt;';
                prev.style.marginRight = '5px';
                prev.disabled = paginationState.currentPage === 0;
                prev.onclick = function () {
                    if (paginationState.currentPage > 0) {
                        paginationState.currentPage--;
                        renderCurrentPage();
                    }
                };

                var next = document.createElement('button');
                next.className = 'btn';
                next.innerHTML = '&gt;';
                next.disabled = paginationState.currentPage >= totalPages - 1;
                next.onclick = function () {
                    if (paginationState.currentPage < totalPages - 1) {
                        paginationState.currentPage++;
                        renderCurrentPage();
                    }
                };

                right.appendChild(prev);
                right.appendChild(next);
            }
        }

        function renderPaginatedList(title, items, itemRenderer, backAction, targetElementId, pageSizeOverride) {
            // Update State
            paginationState.items = items;
            paginationState.title = title;
            paginationState.itemRenderer = itemRenderer;
            paginationState.backAction = backAction;
            // Dynamic calc unless override
            paginationState.pageSize = pageSizeOverride || calculatePageSize();
            paginationState.currentPage = 0;
            // Target is usually content-area or sub-div. 
            // NOTE: We assume targetElementId is inside content-area or IS content-area.
            // For now, simple views reuse #opds-content.

            renderCurrentPage(targetElementId);
        }

        function renderCurrentPage(targetElementId) {
            var content = document.getElementById(targetElementId || 'opds-content');
            content.innerHTML = '';

            // Update Header/Context Bar
            updateContextBar();

            if (paginationState.items.length === 0) {
                content.innerHTML = '<div style="text-align:center; margin-top:50px;">No items found</div>';
                return;
            }

            var start = paginationState.currentPage * paginationState.pageSize;
            var end = Math.min(start + paginationState.pageSize, paginationState.items.length);
            var pageItems = paginationState.items.slice(start, end);

            for (var i = 0; i < pageItems.length; i++) {
                var itemDiv = paginationState.itemRenderer(pageItems[i]);
                if (itemDiv) content.appendChild(itemDiv);
            }
        }

        function showToast(msg) {
            var toast = document.getElementById('message-toast');
            toast.innerText = msg;
            toast.className = '';
            setTimeout(function () { toast.className = 'hidden'; }, 3000);
        }

        function renderPaginatedList(title, items, itemRenderer, backAction, targetElementId, pageSize) {
            var content = document.getElementById(targetElementId || 'opds-content');
            content.innerHTML = '';

            // Update State
            paginationState.items = items;
            paginationState.title = title;
            paginationState.itemRenderer = itemRenderer;
            paginationState.backAction = backAction;
            paginationState.pageSize = pageSize || calculatePageSize();
            // Reset page if new list
            paginationState.currentPage = 0;

            renderCurrentPage(targetElementId);
        }

        function renderCurrentPage(targetElementId) {
            var content = document.getElementById(targetElementId || 'opds-content');
            content.innerHTML = '';

            var totalPages = Math.ceil(paginationState.items.length / paginationState.pageSize);
            var currentPage = paginationState.currentPage;

            // --- Top Navigation Row (Back + Pagination) ---
            var navRow = document.createElement('div');
            navRow.className = 'nav-row';
            navRow.style.display = 'flex';
            navRow.style.justifyContent = 'space-between';
            navRow.style.alignItems = 'center';
            navRow.style.marginBottom = '15px';
            navRow.style.paddingBottom = '10px';
            navRow.style.borderBottom = '1px solid #ccc';

            // Left: Back Button
            var leftGroup = document.createElement('div');
            if (paginationState.backAction) {
                var backBtn = document.createElement('button');
                backBtn.className = 'btn';
                backBtn.innerHTML = '&larr; Back';
                backBtn.style.width = 'auto';
                backBtn.style.padding = '8px 15px';
                backBtn.onclick = paginationState.backAction;
                leftGroup.appendChild(backBtn);
            }
            navRow.appendChild(leftGroup);

            // Center/Right: Title & Pagination Controls
            var rightGroup = document.createElement('div');
            rightGroup.style.display = 'flex';
            rightGroup.style.alignItems = 'center';

            if (totalPages > 1) {
                var prevBtn = document.createElement('button');
                prevBtn.className = 'btn';
                prevBtn.innerText = '< Prev';
                prevBtn.style.width = 'auto';
                prevBtn.style.padding = '8px 10px';
                prevBtn.style.marginRight = '10px';
                prevBtn.disabled = currentPage === 0;
                prevBtn.style.opacity = prevBtn.disabled ? '0.5' : '1';
                prevBtn.onclick = function () {
                    if (paginationState.currentPage > 0) {
                        paginationState.currentPage--;
                        renderCurrentPage(targetElementId);
                        window.scrollTo(0, 0);
                    }
                };

                var pageInfo = document.createElement('span');
                pageInfo.innerText = (currentPage + 1) + ' / ' + totalPages;
                pageInfo.style.margin = '0 10px';
                pageInfo.style.fontWeight = 'bold';
                pageInfo.style.fontSize = '18px';

                var nextBtn = document.createElement('button');
                nextBtn.className = 'btn';
                nextBtn.innerText = 'Next >';
                nextBtn.style.width = 'auto';
                nextBtn.style.padding = '8px 10px';
                nextBtn.style.marginLeft = '10px';
                nextBtn.disabled = currentPage >= totalPages - 1;
                nextBtn.style.opacity = nextBtn.disabled ? '0.5' : '1';
                nextBtn.onclick = function () {
                    if (paginationState.currentPage < totalPages - 1) {
                        paginationState.currentPage++;
                        renderCurrentPage(targetElementId);
                        window.scrollTo(0, 0);
                    }
                };

                rightGroup.appendChild(prevBtn);
                rightGroup.appendChild(pageInfo);
                rightGroup.appendChild(nextBtn);
            }
            navRow.appendChild(rightGroup);
            content.appendChild(navRow);

            // --- Items ---
            if (paginationState.items.length === 0) {
                content.innerHTML += '<center>No items found</center>';
                return;
            }

            var start = currentPage * paginationState.pageSize;
            var end = Math.min(start + paginationState.pageSize, paginationState.items.length);
            var pageItems = paginationState.items.slice(start, end);

            for (var i = 0; i < pageItems.length; i++) {
                var itemDiv = paginationState.itemRenderer(pageItems[i]);
                if (itemDiv) content.appendChild(itemDiv);
            }

            // Optional: Bottom Pagination (Simplified or same as top? User requested top)
            // We can just leave it at the top for now as "Next to the back button" was spec.
        }

        function ajax(method, path, data, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open(method, path, true);
            xhr.setRequestHeader('Content-Type', 'application/json');

            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            callback(null, JSON.parse(xhr.responseText));
                        } catch (e) {
                            callback(null, null);
                        }
                    } else {
                        try {
                            var err = JSON.parse(xhr.responseText);
                            callback(err.error || 'Error', null);
                        } catch (e) {
                            callback('Error', null);
                        }
                    }
                }
            };

            xhr.send(data ? JSON.stringify(data) : null);
        }

        function loadSettings() {
            ajax('GET', '/api/settings', null, function (err, data) {
                if (data) {
                    document.getElementById('kindle-email').value = data.kindle_email || '';
                }
            });
        }

        function saveSettings() {
            var data = {
                kindle_email: document.getElementById('kindle-email').value
            };

            ajax('POST', '/api/settings', data, function (err, res) {
                if (!err) showToast('Saved');
            });
        }

        function switchTab(tab) {
            currentTab = tab;
            var tabs = ['search', 'cloud', 'queue', 'settings'];
            for (var i = 0; i < tabs.length; i++) {
                document.getElementById('view-' + tabs[i]).className = 'hidden';
                document.getElementById('tab-' + tabs[i] + '-btn').className = '';
            }
            document.getElementById('view-' + tab).className = '';
            // document.getElementById('tab-' + tab + '-btn').className = 'nav-link active'; // Logic handled by switchTab click? No, refactor classes.
            // Reset active class
            var links = document.querySelectorAll('.nav-link');
            for (var j = 0; j < links.length; j++) links[j].className = 'nav-link';
            // Find active one (simple check)
            if (tab === 'cloud') links[0].className += ' active';
            if (tab === 'search') links[1].className += ' active';
            if (tab === 'queue') links[2].className += ' active';
            if (tab === 'settings') links[3].className += ' active';

            // Reset Context Bar default
            document.getElementById('ctx-left').innerHTML = '';
            document.getElementById('ctx-center').innerText = (tab.charAt(0).toUpperCase() + tab.slice(1));
            document.getElementById('ctx-right').innerHTML = '';

            if (tab === 'queue') refreshQueue();
            if (tab === 'cloud') renderOPDSMenu();
            if (tab === 'search') renderSearchMenu();
        }

        function renderSearchMenu() {
            var menu = document.getElementById('search-menu');
            var ephemera = document.getElementById('ephemera-search');
            var bsio = document.getElementById('bsio-search-container');

            var left = document.getElementById('ctx-left');
            left.innerHTML = '';
            document.getElementById('ctx-center').innerText = 'Request';
            document.getElementById('ctx-right').innerHTML = '';

            menu.innerHTML = '';
            menu.className = ''; // Explicitly show menu
            ephemera.className = 'hidden';
            bsio.className = 'hidden';

            var intro = document.createElement('p');
            intro.style.margin = '0 0 15px 0';
            intro.style.color = '#666';
            intro.innerText = 'Request books to be added to your cloud library';
            menu.appendChild(intro);

            var options = [
                { title: 'Direct Search', desc: 'Search download sources directly', action: showEphemeraSearch },
                { title: 'Book Series in Order', desc: 'Search for book series by author', action: showBSIOSearchInRequest }
            ];

            for (var i = 0; i < options.length; i++) {
                var div = document.createElement('div');
                div.className = 'opds-item';
                div.innerHTML = '<b>' + options[i].title + '</b><br><small style="color:#666;">' + options[i].desc + '</small>';
                div.onclick = options[i].action;
                menu.appendChild(div);
            }
        }

        function showEphemeraSearch() {
            document.getElementById('search-menu').className = 'hidden';
            var ephemera = document.getElementById('ephemera-search');
            ephemera.className = '';
            document.getElementById('bsio-search-container').className = 'hidden';

            // Add Back button if not present in the card
            var card = ephemera.querySelector('.card');
            if (!card.querySelector('.back-btn')) {
                var backBtn = document.createElement('div');
                backBtn.className = 'back-btn opds-item';
                backBtn.style.marginBottom = '15px';
                backBtn.innerHTML = '<b>&larr; Back</b>';
                backBtn.onclick = renderSearchMenu;
                ephemera.insertBefore(backBtn, card);
            }

            document.getElementById('search-results').innerHTML = '';
        }

        function showBSIOSearchInRequest() {
            document.getElementById('search-menu').className = 'hidden';
            document.getElementById('ephemera-search').className = 'hidden';
            document.getElementById('bsio-search-container').className = '';

            var container = document.getElementById('bsio-search-container');
            container.innerHTML = '';

            var back = document.createElement('div');
            back.className = 'opds-item';
            back.innerHTML = '<b>&larr; Back</b>';
            back.onclick = function () {
                renderSearchMenu();
            };
            container.appendChild(back);

            var header = document.createElement('div');
            header.className = 'section-header';
            header.innerText = 'Search Book Series in Order';
            container.appendChild(header);

            var card = document.createElement('div');
            card.className = 'card';

            var p = document.createElement('p');
            p.style.marginTop = '0';
            p.style.color = '#666';
            p.innerText = 'Search for an author to see their book series';
            card.appendChild(p);

            var input = document.createElement('input');
            input.type = 'text';
            input.id = 'bsio-search-input';
            input.placeholder = 'Enter author name (e.g., Lee Child)';
            card.appendChild(input);

            var button = document.createElement('button');
            button.className = 'btn';
            button.innerText = 'Search';
            button.onclick = searchBSIOAuthorsInRequest;
            card.appendChild(button);

            container.appendChild(card);

            var resultsDiv = document.createElement('div');
            resultsDiv.id = 'bsio-results';
            container.appendChild(resultsDiv);
        }

        function renderOPDSMenu() {
            var content = document.getElementById('opds-content');
            content.innerHTML = '';
            opdsHistory = [];

            // Reset Context Bar for main menu
            document.getElementById('ctx-left').innerHTML = '';
            document.getElementById('ctx-center').innerText = 'Library';
            document.getElementById('ctx-right').innerHTML = '';

            var intro = document.createElement('p');
            intro.style.margin = '0 0 15px 0';
            intro.style.color = '#666';
            intro.innerText = 'Select a book from your cloud library to download it to your Kindle.';
            content.appendChild(intro);

            var menu = [
                { title: 'Recent Books', path: 'recent', isRecent: true },
                { title: 'Authors', path: '/authors' }
            ];

            for (var i = 0; i < menu.length; i++) {
                var div = document.createElement('div');
                div.className = 'opds-item';
                div.innerHTML = '<b>' + menu[i].title + '</b>';
                div.onclick = (function (item) {
                    return function () {
                        if (item.isRecent) {
                            browseRecentBooks();
                        } else {
                            browseOPDS(item.path);
                        }
                    };
                })(menu[i]);
                content.appendChild(div);
            }
        }

        function browseRecentBooks() {
            var content = document.getElementById('opds-content');
            content.innerHTML = '<center>Loading...</center>';

            ajax('GET', '/api/opds/browse?url=' + encodeURIComponent('/recent?page=1&size=100'), null, function (err, data) {
                if (err || !data) {
                    content.innerHTML = '<center>Error loading</center>';
                    return;
                }

                opdsData = data.entries || [];
                renderRecentBooksList();
            });
        }

        function renderRecentBooksList() {
            var content = document.getElementById('opds-content');
            // Render with dynamic pagination
            renderPaginatedList('Recent Books', opdsData, createBookItemDiv, function () { renderOPDSMenu(); });
        }

        // Helper to create book item div (moved from renderBookItem to return element)
        function createBookItemDiv(book) {
            var acqLink = null;
            var thumbnail = '';

            for (var j = 0; j < book.links.length; j++) {
                if (book.links[j].rel && book.links[j].rel.indexOf('acquisition') !== -1) {
                    acqLink = book.links[j];
                }
                if (book.links[j].rel && book.links[j].rel.indexOf('thumbnail') !== -1) {
                    thumbnail = book.links[j].href;
                }
            }

            if (!acqLink) return null;

            var div = document.createElement('div');
            // Use 'book-row' class from new CSS which enforces height
            div.className = 'book-row';

            var seriesInfo = '';
            if (book.series_name) {
                seriesInfo = '<div class="book-meta">' + book.series_name + ' #' + (book.series_index || '?') + '</div>';
            }

            var coverHtml = '<div class="book-cover">';
            if (thumbnail) {
                coverHtml += '<img src="' + thumbnail + '" onerror="this.src=\'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSIxMDUiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IiNlZWUiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzk5OSIgZm9udC1zaXplPSIxMCI+Tm8gQ292ZXI8L3RleHQ+PC9zdmc+\';">';
            } else {
                coverHtml += '<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MCIgaGVpZ2h0PSIxMDUiPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IiNlZWUiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzk5OSIgZm9udC1zaXplPSIxMCI+Tm8gQ292ZXI8L3RleHQ+PC9zdmc+">';
            }

            // Button: We want it small and accessible.
            // Maybe inside the cover column? Or in info?
            // Spec said "Button underneath image" previously. Let's keep that but compact.
            coverHtml += '<button class="btn" style="width:100%; margin-top:4px; font-size:16px; padding:2px;" onclick="sendToKindle(\'' + acqLink.href.replace(/'/g, "\\'") + '\'); event.stopPropagation();">SEND</button>';
            coverHtml += '</div>';

            var descText = book.description || '';
            var readMore = '';
            // If description exists, provide a way to read it.
            // In rigid layout, we can't show much text.
            // We'll add a [Info] button or link in meta.
            if (descText) {
                readMore = ' &nbsp;<a href="#" onclick="showModal(\'' + escapeHtml(descText) + '\'); return false;">[INFO]</a>';
            }

            div.innerHTML = coverHtml +
                '<div class="book-info">' +
                '<div class="book-title">' + book.title + '</div>' +
                '<div class="book-meta">' + (book.authors ? book.authors.join(', ') : 'Unknown') + '</div>' +
                seriesInfo +
                '<div class="book-meta" style="margin-top:5px; color:#555;">' + readMore + '</div>' +
                '</div>';

            return div;
        }

        // Modal Helpers
        function showModal(content) {
            document.getElementById('modal-text').innerHTML = content;
            document.getElementById('desc-modal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('desc-modal').style.display = 'none';
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;")
                .replace(/\n/g, '<br>'); // Simple newline handling for plain text
        }

        function browseOPDS(path) {
            var content = document.getElementById('opds-content');
            content.innerHTML = '<center>Loading...</center>';

            var url = path.indexOf('http') === 0 ? path : '';
            var urlParam = url ? '?url=' + encodeURIComponent(url) : '?url=' + encodeURIComponent(path);

            ajax('GET', '/api/opds/browse' + urlParam, null, function (err, data) {
                if (err || !data) {
                    content.innerHTML = '<center>Error loading</center>';
                    return;
                }

                opdsData = data.entries || [];
                renderOPDSList(path);
            });
        }

        function renderOPDSList(currentPath) {
            var content = document.getElementById('opds-content');
            content.innerHTML = ''; // Clear loading message immediately

            var backAction = function () {
                if (opdsHistory.length > 0) {
                    var last = opdsHistory.pop();
                    browseOPDS(last);
                } else {
                    renderOPDSMenu(); // Default fallback to main OPDS menu
                }
            };

            // Check if this is an author page (has books with acquisition links)
            var hasBooks = false;
            for (var i = 0; i < opdsData.length; i++) {
                for (var j = 0; j < opdsData[i].links.length; j++) {
                    if (opdsData[i].links[j].rel && opdsData[i].links[j].rel.indexOf('acquisition') !== -1) {
                        hasBooks = true;
                        break;
                    }
                }
                if (hasBooks) break;
            }

            if (hasBooks) {
                renderAuthorDrilldown(backAction); // Pass backAction to drilldown
                return;
            }

            // Regular navigation list (6 items per page for authors/folders)
            renderPaginatedList('', opdsData, function (entry) {
                var navLink = null;
                var acqLink = null;

                for (var j = 0; j < entry.links.length; j++) {
                    var link = entry.links[j];
                    if (link.rel && link.rel.indexOf('subsection') !== -1) {
                        navLink = link;
                    }
                    if (link.rel && link.rel.indexOf('acquisition') !== -1) {
                        acqLink = link;
                    }
                }

                var div = document.createElement('div');
                div.className = 'opds-item';

                if (navLink) {
                    div.innerHTML = '<b>' + entry.title + '</b>';
                    div.onclick = (function (path, href) {
                        return function () {
                            opdsHistory.push(path);
                            browseOPDS(href);
                        };
                    })(currentPath, navLink.href);
                } else if (acqLink) {
                    // Reuse book helper if needed, but this is usually sparse info in browse view
                    return createBookItemDiv(entry);
                }
                return div;

            }, backAction);
        }

        function renderSeriesBooks(seriesName, books, backActionOverride) {
            var content = document.getElementById('opds-content');
            var backAction = backActionOverride || function () {
                renderOPDSList(opdsHistory[opdsHistory.length - 1] || '');
            };

            // Sort by series index
            books.sort(function (a, b) {
                return (parseFloat(a.series_index) || 0) - (parseFloat(b.series_index) || 0);
            });

            // Series Books view - dynamic page size
            renderPaginatedList(seriesName, books, createBookItemDiv, backAction);
        }

        // Deprecated separated renderers, now handled by combined drilldown or generic lists
        function renderStandaloneBooks(books) {
            var content = document.getElementById('opds-content');
            var backAction = function () {
                renderOPDSList(opdsHistory[opdsHistory.length - 1] || '');
            };

            renderPaginatedList('Standalone Books', books, createBookItemDiv, backAction, null, 4);
        }

        function renderAllBooks(books) {
            var content = document.getElementById('opds-content');
            var backAction = function () {
                renderOPDSList(opdsHistory[opdsHistory.length - 1] || '');
            };

            // Sort by title
            books.sort(function (a, b) {
                return a.title.localeCompare(b.title);
            });

            renderPaginatedList('All Books', books, createBookItemDiv, backAction, null, 4);
        }

        // Deprecated simple renderBookItem (kept as wrapper just in case, but unused now)
        function renderBookItem(book) {
            var div = createBookItemDiv(book);
            if (div) document.getElementById('opds-content').appendChild(div);
        }

        function sendToKindle(url) {
            showToast('Sending...');
            ajax('POST', '/api/opds/send-to-kindle', { url: url }, function (err, res) {
                if (err) {
                    showToast('Error: ' + err);
                } else {
                    showToast('Sent to Kindle!');
                }
            });
        }

        function performSearch() {
            var query = document.getElementById('search-input').value;
            if (!query) return;

            var results = document.getElementById('search-results');
            var searchCard = document.getElementById('search-input-card');

            results.innerHTML = '<center>Searching...</center>';

            ajax('GET', '/api/ephemera/search?q=' + encodeURIComponent(query), null, function (err, data) {
                results.innerHTML = '';

                // Helper to restore search input
                var restoreSearch = function () {
                    searchCard.classList.remove('hidden');
                    results.innerHTML = '';
                };

                // Helper to show error/empty with Back button
                var showMessage = function (msg) {
                    searchCard.classList.add('hidden');
                    results.innerHTML = '<center>' + msg + '</center><br><button class="btn" onclick="document.getElementById(\'search-input-card\').classList.remove(\'hidden\'); document.getElementById(\'search-results\').innerHTML=\'\';">Back</button>';
                };

                if (err || !data) {
                    showMessage('Error');
                    return;
                }
                if (data.error) {
                    showMessage(data.error);
                    return;
                }
                if (!data.length) {
                    showMessage('No results');
                    return;
                }

                // Hide search input on success
                searchCard.classList.add('hidden');

                // Helper for relevance sorting
                function levenshtein(a, b) {
                    var tmp;
                    if (a.length === 0) { return b.length; }
                    if (b.length === 0) { return a.length; }
                    if (a.length > b.length) { tmp = a; a = b; b = tmp; }

                    var row = [];
                    for (var i = 0; i <= a.length; i++) { row[i] = i; }

                    for (var i = 1; i <= b.length; i++) {
                        var prev = i;
                        for (var j = 1; j <= a.length; j++) {
                            var val;
                            if (b.charAt(i - 1) === a.charAt(j - 1)) {
                                val = row[j - 1];
                            } else {
                                val = Math.min(row[j - 1] + 1, Math.min(prev + 1, row[j] + 1));
                            }
                            row[j - 1] = prev;
                            prev = val;
                        }
                        row[a.length] = prev;
                    }
                    return row[a.length];
                }

                // Sort by relevance (Levenshtein distance of title to query)
                var qLower = query.toLowerCase().trim();
                data.sort(function (a, b) {
                    var distA = levenshtein(a.title.toLowerCase().trim(), qLower);
                    var distB = levenshtein(b.title.toLowerCase().trim(), qLower);
                    return distA - distB;
                });

                // Render paginated results
                renderPaginatedList(
                    'Search Results',
                    data,
                    function (book) {
                        var div = document.createElement('div');
                        div.className = 'book-card';
                        div.style.cursor = 'default';

                        var authors = book.authors ? book.authors.join(', ') : 'Unknown';

                        var coverHtml = '<div class="book-cover">';
                        if (book.coverUrl) {
                            coverHtml += '<img src="' + book.coverUrl + '" onerror="this.src=\'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTgwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZWVlIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5OTkiIGZvbnQtc2l6ZT0iMTQiPk5vIENvdmVyPC90ZXh0Pjwvc3ZnPg==\';">';
                        } else {
                            coverHtml += '<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTgwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZWVlIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5OTkiIGZvbnQtc2l6ZT0iMTQiPk5vIENvdmVyPC90ZXh0Pjwvc3ZnPg==">';
                        }
                        coverHtml += '<button class="btn" onclick="showReleases(\'' + book.md5 + '\')">View Releases</button>';
                        coverHtml += '</div>';

                        var description = book.description ? book.description : '';
                        if (description.length > 200) description = description.substring(0, 200) + '...';

                        div.innerHTML = '<div class="book-row">' + coverHtml +
                            '<div class="book-info">' +
                            '<b>' + book.title + '</b>' +
                            '<br><small style="color:#666;">' + authors + '</small>' +
                            '<br><div style="font-size:0.85em; margin-top:5px; color:#444;">' + description + '</div>' +
                            '</div></div>';
                        return div;
                    },
                    restoreSearch, // Back action restores visibility
                    'search-results', // Target the search-results div
                    4 // Page size
                );
            });
        }

        function addBook(md5) {
            // Keep for backward compatibility or direct actions if needed
            ajax('POST', '/api/ephemera/download', { md5: md5, title: '' }, function (err, res) {
                if (!err) showToast('Queued');
            });
        }

        function showReleases(md5) {
            // Backup current search state
            searchStateBackup = {
                items: paginationState.items,
                currentPage: paginationState.currentPage,
                title: paginationState.title,
                backAction: paginationState.backAction,
                itemRenderer: paginationState.itemRenderer
            };

            document.getElementById('ephemera-search').className = 'hidden';
            var container = document.getElementById('releases-container');
            container.className = '';
            container.innerHTML = '<center>Loading releases...</center>';

            ajax('GET', '/api/ephemera/releases?md5=' + encodeURIComponent(md5), null, function (err, data) {
                if (err || !data) {
                    container.innerHTML = '<center>Error loading releases: ' + (err || 'Unknown error') + '</center>';
                    container.innerHTML += '<br><button class="btn" onclick="backToSearch()">Back</button>';
                    return;
                }

                if (data.error) {
                    container.innerHTML = '<center>' + data.error + '</center>';
                    container.innerHTML += '<br><button class="btn" onclick="backToSearch()">Back</button>';
                    return;
                }

                if (!data.length) {
                    container.innerHTML = '<center>No releases found</center>';
                    container.innerHTML += '<br><button class="btn" onclick="backToSearch()">Back</button>';
                    return;
                }

                renderReleasesTable(container, data);
            });
        }

        function backToSearch() {
            document.getElementById('releases-container').className = 'hidden';
            var ephemera = document.getElementById('ephemera-search');
            ephemera.className = '';

            // Restore search state if available
            if (searchStateBackup) {
                renderPaginatedList(
                    searchStateBackup.title,
                    searchStateBackup.items,
                    searchStateBackup.itemRenderer,
                    searchStateBackup.backAction,
                    'search-results'
                );
                // Restore page number logic could be added here if renderPaginatedList supported startPage
                // For now, it resets to page 0, which is acceptable but better than empty
                // To support page restore, we'd need to modify renderPaginatedList or manually set it:
                paginationState.currentPage = searchStateBackup.currentPage;
                renderCurrentPage('search-results');
            }
        }

        function renderReleasesTable(container, releases) {
            var filtered = [];
            for (var i = 0; i < releases.length; i++) {
                var fmt = (releases[i].format || '').toLowerCase();
                if (fmt.indexOf('epub') !== -1 || fmt.indexOf('mobi') !== -1) {
                    filtered.push(releases[i]);
                }
            }

            if (filtered.length === 0) {
                container.innerHTML = '<center>No EPUB/MOBI releases found</center><br><button class="btn" onclick="backToSearch()">Back</button>';
                return;
            }

            renderPaginatedList(
                'Select a Release',
                filtered,
                function (release) {
                    var div = document.createElement('div');
                    div.className = 'book-card';

                    var title = release.title || 'Unknown Title';
                    var source = release.source || 'Unknown Source';

                    var sizeStr = '';
                    if (release.size_bytes) {
                        sizeStr = (release.size_bytes / 1024 / 1024).toFixed(1) + ' MB';
                    } else if (release.size) {
                        sizeStr = release.size;
                    }

                    var seedsStr = '';
                    if (release.seeders !== null && release.seeders !== undefined) {
                        seedsStr = release.seeders + ' seeds';
                    }

                    var format = release.format || '';
                    var lang = release.language || '';

                    var metaParts = [];
                    if (source) metaParts.push(source);
                    if (lang) metaParts.push(lang);
                    if (format) metaParts.push(format);
                    if (sizeStr) metaParts.push(sizeStr);
                    if (seedsStr) metaParts.push(seedsStr);

                    var metaHtml = metaParts.join(' â€¢ ');

                    div.innerHTML = '<b>' + title + '</b><br>' +
                        '<small>' + metaHtml + '</small><br>' +
                        '<button class="btn" style="margin-top:10px;" onclick=\'downloadRelease(' + JSON.stringify(release).replace(/'/g, "&#39;") + ')\'>Download</button>';
                    return div;
                },
                backToSearch,
                'releases-container'
            );
        }

        function downloadRelease(release) {
            showToast('Queueing...');
            ajax('POST', '/api/ephemera/download', release, function (err, res) {
                if (!err) {
                    showToast('Queued!');
                    backToSearch();
                } else {
                    showToast('Error: ' + err);
                }
            });
        }

        function refreshQueue() {
            if (currentTab !== 'queue') return;

            var list = document.getElementById('queue-list');
            list.innerHTML = '<center>Loading...</center>';

            ajax('GET', '/api/ephemera/queue', null, function (err, res) {
                list.innerHTML = '';

                if (err || !res) {
                    list.innerHTML = '<center>Error</center>';
                    return;
                }

                if (res.error && typeof res.error === 'string') {
                    list.innerHTML = '<center>' + res.error + '</center>';
                    return;
                }

                var allItems = [];
                var categories = ['queued', 'downloading', 'done', 'error', 'delayed', 'cancelled', 'available'];

                for (var i = 0; i < categories.length; i++) {
                    var cat = categories[i];
                    if (res[cat]) {
                        for (var md5 in res[cat]) {
                            if (res[cat].hasOwnProperty(md5)) {
                                var item = res[cat][md5];
                                item.status = cat;
                                allItems.push(item);
                            }
                        }
                    }
                }

                if (allItems.length === 0) {
                    list.innerHTML = '<center>Queue empty</center>';
                    return;
                }

                for (var i = 0; i < allItems.length; i++) {
                    var item = allItems[i];
                    var div = document.createElement('div');
                    div.className = 'queue-item';

                    var statusHtml = 'Status: ' + item.status;
                    if (item.status_message) {
                        var color = item.status === 'error' ? 'red' : '#666';
                        statusHtml += '<br><small style="color:' + color + ';">' + item.status_message + '</small>';
                    }

                    div.innerHTML = '<b>' + (item.title || item.filename || 'Unknown') + '</b><br>' +
                        '<small>' + statusHtml + '</small>';
                    list.appendChild(div);
                }
            });
        }

        function searchBSIOAuthorsInRequest() {
            var query = document.getElementById('bsio-search-input').value;
            if (!query) return;

            var results = document.getElementById('bsio-results');
            results.innerHTML = '<center>Searching...</center>';

            ajax('GET', '/api/bookseriesinorder/search?q=' + encodeURIComponent(query), null, function (err, data) {
                results.innerHTML = '';

                if (err || !data) {
                    results.innerHTML = '<center>Error searching</center>';
                    return;
                }

                if (data.error) {
                    results.innerHTML = '<center>' + data.error + '</center>';
                    return;
                }

                if (!data.length) {
                    results.innerHTML = '<center>No authors found</center>';
                    return;
                }

                showBSIOAuthorListInRequest(data);
            });
        }

        function showBSIOAuthorListInRequest(authors) {
            renderPaginatedList(
                'Authors Found',
                authors,
                function (author) {
                    var div = document.createElement('div');
                    div.className = 'opds-item';

                    var html = '<b>' + author.name + '</b>';
                    if (author.description) {
                        html += '<br><small style="color:#666;">' + author.description + '</small>';
                    }

                    div.innerHTML = html;
                    div.onclick = (function (url, name) {
                        return function () {
                            showBSIOAuthorBooksInRequest(url, name);
                        };
                    })(author.url, author.name);
                    return div;
                },
                renderSearchMenu, // Back to menu
                'bsio-results'
            );
        }

        function showBSIOAuthorBooksInRequest(authorUrl, authorName) {
            var container = document.getElementById('bsio-search-container');
            container.innerHTML = '<center>Loading...</center>';

            ajax('GET', '/api/bookseriesinorder/author?url=' + encodeURIComponent(authorUrl), null, function (err, data) {
                if (err || !data) {
                    container.innerHTML = '<center>Error loading author books</center>';
                    return;
                }

                if (data.error) {
                    container.innerHTML = '<center>' + data.error + '</center>';
                    return;
                }

                container.innerHTML = '';

                var back = document.createElement('div');
                back.className = 'opds-item';
                back.innerHTML = '<b>&larr; Back</b>';
                back.onclick = function () {
                    showBSIOSearchInRequest();
                };
                container.appendChild(back);

                var header = document.createElement('div');
                header.className = 'section-header';
                header.innerText = data.author || authorName;
                container.appendChild(header);

                if (!data.series || data.series.length === 0) {
                    var noBooks = document.createElement('p');
                    noBooks.style.textAlign = 'center';
                    noBooks.style.color = '#666';
                    noBooks.innerText = 'No series found for this author';
                    container.appendChild(noBooks);
                    return;
                }

                // Collect all book titles to check library status
                var allTitles = [];
                for (var i = 0; i < data.series.length; i++) {
                    for (var j = 0; j < data.series[i].books.length; j++) {
                        allTitles.push(data.series[i].books[j].title);
                    }
                }


                // Check library status
                ajax('POST', '/api/opds/check-library', { titles: allTitles, author: data.author || authorName }, function (libErr, libData) {
                    var libraryStatus = {};
                    if (!libErr && libData && libData.results) {
                        libraryStatus = libData.results;
                    }

                    // Flatten items for pagination
                    var flatItems = [];
                    for (var i = 0; i < data.series.length; i++) {
                        var series = data.series[i];
                        // Add Series Header as a special item
                        flatItems.push({ type: 'header', text: series.name, count: series.books.length });

                        for (var j = 0; j < series.books.length; j++) {
                            var book = series.books[j];
                            book.type = 'book';
                            flatItems.push(book);
                        }
                    }

                    renderPaginatedList(
                        data.author || authorName,
                        flatItems,
                        function (item) {
                            if (item.type === 'header') {
                                var seriesHeader = document.createElement('div');
                                seriesHeader.style.fontSize = '28px';
                                seriesHeader.style.fontWeight = 'bold';
                                seriesHeader.style.marginTop = '20px';
                                seriesHeader.style.marginBottom = '10px';
                                seriesHeader.innerHTML = item.text + ' <small style="color:#666;">(' + item.count + ' books)</small>';
                                return seriesHeader;
                            } else {
                                var bookDiv = document.createElement('div');
                                bookDiv.className = 'opds-item';
                                bookDiv.style.cursor = 'default';
                                bookDiv.style.padding = '10px';

                                var bookHtml = '<b>' + item.title + '</b><br>';

                                var libStatus = libraryStatus[item.title] || { in_library: false };
                                var inLibrary = libStatus.in_library || false;

                                if (inLibrary) {
                                    bookHtml += '<small style="color:#0a0; font-weight:bold;">IN LIBRARY';
                                    if (libStatus.match_score && libStatus.match_score < 100) {
                                        bookHtml += ' (' + libStatus.match_score + '% match)';
                                    }
                                    bookHtml += '</small> ';

                                    if (libStatus.download_url) {
                                        bookHtml += '<button class="btn" style="display:inline-block; width:auto; padding:8px 15px; margin-left:10px; font-size:18px; background:#0a0;" onclick="sendToKindle(\'' + libStatus.download_url.replace(/'/g, "\\'") + '\'); event.stopPropagation();">Send to EReader</button>';
                                    }
                                } else {
                                    bookHtml += '<small style="color:#666;">NOT IN LIBRARY</small> ';

                                    var searchQuery = (data.author || authorName) + ' ' + item.title;
                                    // Remove text in parentheses from search query
                                    searchQuery = searchQuery.replace(/\([^)]*\)/g, '').replace(/\s+/g, ' ').trim();
                                    bookHtml += '<button class="btn" style="display:inline-block; width:auto; padding:8px 15px; margin-left:10px; font-size:18px;" onclick="searchEphemeraFor(\'' + searchQuery.replace(/'/g, "\\'") + '\'); event.stopPropagation();">Search for Download</button>';
                                }

                                if (item.amazon_link) {
                                    bookHtml += '<br><a href="' + item.amazon_link + '" target="_blank" style="color:#666; font-size:18px; margin-top:5px; display:inline-block;">View on Amazon</a>';
                                }

                                bookDiv.innerHTML = bookHtml;
                                return bookDiv;
                            }
                        },
                        showBSIOSearchInRequest, // Back action
                        'bsio-search-container'
                    );
                });
            });
        }


        function searchEphemeraFor(query) {
            // Switch to Request tab, then to Ephemera search
            switchTab('search');
            showEphemeraSearch();

            // Set the search query and trigger search
            document.getElementById('search-input').value = query;
            performSearch();
        }

        loadSettings();
        renderOPDSMenu();
    </script>
</body>

</html>
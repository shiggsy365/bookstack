<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BookStack Web</title>
    <style>
        body { font-family: sans-serif; background: #f0f0f0; margin: 0; padding: 0; font-size: 24px; }
        .header { background: #fff; border-bottom: 2px solid #000; padding: 15px; text-align: center; font-size: 36px; font-weight: bold; }
        .nav { background: #fff; border-bottom: 1px solid #000; }
        .nav a { display: inline-block; padding: 15px; text-decoration: none; color: #666; font-weight: bold; width: 24%; text-align: center; box-sizing: border-box; font-size: 24px; }
        .nav a.active { color: #000; border-bottom: 3px solid #000; }
        .container { padding: 15px; }
        .card { background: #fff; border: 1px solid #000; padding: 15px; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; border: 1px solid #ccc; margin-bottom: 10px; box-sizing: border-box; font-size: 24px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 21px; text-transform: uppercase; }
        .book-card { background: #fff; border: 1px solid #000; padding: 15px; margin-bottom: 10px; font-size: 24px; }
        .btn { background: #000; color: #fff; border: none; padding: 12px 20px; cursor: pointer; font-size: 24px; width: 100%; font-weight: bold; }
        .queue-item { background: #fff; border: 1px solid #000; padding: 10px; margin-bottom: 5px; font-size: 24px; }
        .hidden { display: none; }
        #message-toast { position: fixed; bottom: 20px; left: 50%; margin-left: -100px; background: #333; color: #fff; padding: 10px 20px; width: 200px; text-align: center; font-size: 24px; }
        .opds-item { background: #fff; border: 1px solid #000; padding: 15px; margin-bottom: 10px; cursor: pointer; font-size: 24px; }
        .opds-item:hover { background: #f5f5f5; }
        .book-row { display: table; width: 100%; }
        .book-cover { display: table-cell; width: 140px; vertical-align: top; padding-right: 15px; }
        .book-cover img { width: 140px; height: 210px; border: 1px solid #ccc; object-fit: cover; display: block; margin-bottom: 10px; }
        .book-info { display: table-cell; vertical-align: top; }
        .book-description { margin-top: 8px; color: #555; font-size: 21px; line-height: 1.4; }
        p { font-size: 24px; line-height: 1.4; }
        .section-header { font-size: 30px; font-weight: bold; padding: 15px 0; }
        small { font-size: 21px; }
    </style>
</head>
<body>
    <div class="header"><b>Cloud Library</b></div>
    
    <div class="nav">
        <a href="#" id="tab-cloud-btn" class="active" onclick="switchTab('cloud'); return false;">Library</a>
        <a href="#" id="tab-search-btn" onclick="switchTab('search'); return false;">Request</a>
        <a href="#" id="tab-queue-btn" onclick="switchTab('queue'); return false;">Queue</a>
        <a href="#" id="tab-settings-btn" onclick="switchTab('settings'); return false;">...</a>
    </div>

    <div class="container">
        <div id="view-cloud">
            <div id="opds-content"></div>
        </div>

        <div id="view-search" class="hidden">
            <div id="search-menu"></div>
            <div id="ephemera-search" class="hidden">
                <div class="card">
                    <p style="margin-top:0; color:#666;">Search for a book to add to the Cloud Library</p>
                    <input type="text" id="search-input" placeholder="Search Ephemera...">
                    <button class="btn" onclick="performSearch()">Search</button>
                </div>
                <div id="search-results"></div>
            </div>
            <div id="bsio-search-container" class="hidden"></div>
        </div>

        <div id="view-queue" class="hidden">
            <p style="margin:0 0 15px 0; color:#666;">Requested books will appear in the cloud library when marked as complete below</p>
            <div id="queue-list"></div>
        </div>

        <div id="view-settings" class="hidden">
            <div class="card">
                <label>Send to Kindle Email</label>
                <input type="email" id="kindle-email" placeholder="username@kindle.com">
                <button class="btn" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <div id="message-toast" class="hidden"></div>

    <script>
        var currentTab = 'cloud';
        var opdsHistory = [];
        var opdsData = [];

        function showToast(msg) {
            var toast = document.getElementById('message-toast');
            toast.innerText = msg;
            toast.className = '';
            setTimeout(function() { toast.className = 'hidden'; }, 3000);
        }

        function ajax(method, path, data, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open(method, path, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            callback(null, JSON.parse(xhr.responseText));
                        } catch (e) {
                            callback(null, null);
                        }
                    } else {
                        try {
                            var err = JSON.parse(xhr.responseText);
                            callback(err.error || 'Error', null);
                        } catch (e) {
                            callback('Error', null);
                        }
                    }
                }
            };
            
            xhr.send(data ? JSON.stringify(data) : null);
        }

        function loadSettings() {
            ajax('GET', '/api/settings', null, function(err, data) {
                if (data) {
                    document.getElementById('kindle-email').value = data.kindle_email || '';
                }
            });
        }

        function saveSettings() {
            var data = {
                kindle_email: document.getElementById('kindle-email').value
            };
            
            ajax('POST', '/api/settings', data, function(err, res) {
                if (!err) showToast('Saved');
            });
        }

        function switchTab(tab) {
            currentTab = tab;
            var tabs = ['search', 'cloud', 'queue', 'settings'];
            for (var i = 0; i < tabs.length; i++) {
                document.getElementById('view-' + tabs[i]).className = 'hidden';
                document.getElementById('tab-' + tabs[i] + '-btn').className = '';
            }
            document.getElementById('view-' + tab).className = '';
            document.getElementById('tab-' + tab + '-btn').className = 'active';
            if (tab === 'queue') refreshQueue();
            if (tab === 'cloud') renderOPDSMenu();
            if (tab === 'search') renderSearchMenu();
        }

        function renderSearchMenu() {
            var menu = document.getElementById('search-menu');
            var ephemera = document.getElementById('ephemera-search');
            var bsio = document.getElementById('bsio-search-container');

            menu.innerHTML = '';
            ephemera.className = 'hidden';
            bsio.className = 'hidden';

            var intro = document.createElement('p');
            intro.style.margin = '0 0 15px 0';
            intro.style.color = '#666';
            intro.innerText = 'Request books to be added to your cloud library';
            menu.appendChild(intro);

            var options = [
                {title: 'Direct Search', desc: 'Search Ephemera for books', action: showEphemeraSearch},
                {title: 'Book Series in Order', desc: 'Search for book series by author', action: showBSIOSearchInRequest}
            ];

            for (var i = 0; i < options.length; i++) {
                var div = document.createElement('div');
                div.className = 'opds-item';
                div.innerHTML = '<b>' + options[i].title + '</b><br><small style="color:#666;">' + options[i].desc + '</small>';
                div.onclick = options[i].action;
                menu.appendChild(div);
            }
        }

        function showEphemeraSearch() {
            document.getElementById('search-menu').className = 'hidden';
            document.getElementById('ephemera-search').className = '';
            document.getElementById('bsio-search-container').className = 'hidden';
            document.getElementById('search-results').innerHTML = '';
        }

        function showBSIOSearchInRequest() {
            document.getElementById('search-menu').className = 'hidden';
            document.getElementById('ephemera-search').className = 'hidden';
            document.getElementById('bsio-search-container').className = '';

            var container = document.getElementById('bsio-search-container');
            container.innerHTML = '';

            var back = document.createElement('div');
            back.className = 'opds-item';
            back.innerHTML = '<b>&larr; Back</b>';
            back.onclick = function() {
                renderSearchMenu();
            };
            container.appendChild(back);

            var header = document.createElement('div');
            header.className = 'section-header';
            header.innerText = 'Search Book Series in Order';
            container.appendChild(header);

            var card = document.createElement('div');
            card.className = 'card';

            var p = document.createElement('p');
            p.style.marginTop = '0';
            p.style.color = '#666';
            p.innerText = 'Search for an author to see their book series';
            card.appendChild(p);

            var input = document.createElement('input');
            input.type = 'text';
            input.id = 'bsio-search-input';
            input.placeholder = 'Enter author name (e.g., Lee Child)';
            card.appendChild(input);

            var button = document.createElement('button');
            button.className = 'btn';
            button.innerText = 'Search';
            button.onclick = searchBSIOAuthorsInRequest;
            card.appendChild(button);

            container.appendChild(card);

            var resultsDiv = document.createElement('div');
            resultsDiv.id = 'bsio-results';
            container.appendChild(resultsDiv);
        }

        function renderOPDSMenu() {
            var content = document.getElementById('opds-content');
            content.innerHTML = '';
            opdsHistory = [];

            var intro = document.createElement('p');
            intro.style.margin = '0 0 15px 0';
            intro.style.color = '#666';
            intro.innerText = 'Select a book from your cloud library to download it to your Kindle.';
            content.appendChild(intro);

            var menu = [
                {title: 'Recent Books', path: 'recent', isRecent: true},
                {title: 'Authors', path: '/authors'}
            ];

            for (var i = 0; i < menu.length; i++) {
                var div = document.createElement('div');
                div.className = 'opds-item';
                div.innerHTML = '<b>' + menu[i].title + '</b>';
                div.onclick = (function(item) {
                    return function() {
                        if (item.isRecent) {
                            browseRecentBooks();
                        } else {
                            browseOPDS(item.path);
                        }
                    };
                })(menu[i]);
                content.appendChild(div);
            }
        }

        function browseRecentBooks() {
            var content = document.getElementById('opds-content');
            content.innerHTML = '<center>Loading...</center>';
            
            ajax('GET', '/api/opds/browse?url=' + encodeURIComponent('/recent?page=1&size=100'), null, function(err, data) {
                if (err || !data) {
                    content.innerHTML = '<center>Error loading</center>';
                    return;
                }
                
                opdsData = data.entries || [];
                renderRecentBooksList();
            });
        }

        function renderRecentBooksList() {
            var content = document.getElementById('opds-content');
            content.innerHTML = '';
            
            var back = document.createElement('div');
            back.className = 'opds-item';
            back.innerHTML = '<b>&larr; Back</b>';
            back.onclick = function() {
                renderOPDSMenu();
            };
            content.appendChild(back);
            
            var header = document.createElement('div');
            header.className = 'section-header';
            header.innerText = 'Recent Books';
            content.appendChild(header);
            
            // Filter to only books with acquisition links
            var books = [];
            for (var i = 0; i < opdsData.length; i++) {
                var hasAcq = false;
                for (var j = 0; j < opdsData[i].links.length; j++) {
                    if (opdsData[i].links[j].rel && opdsData[i].links[j].rel.indexOf('acquisition') !== -1) {
                        hasAcq = true;
                        break;
                    }
                }
                if (hasAcq) {
                    books.push(opdsData[i]);
                }
            }
            
            if (books.length === 0) {
                content.innerHTML += '<center>No recent books found</center>';
                return;
            }
            
            // Books are already sorted by recent date from OPDS feed
            for (var i = 0; i < books.length; i++) {
                renderBookItem(books[i]);
            }
        }

        function browseOPDS(path) {
            var content = document.getElementById('opds-content');
            content.innerHTML = '<center>Loading...</center>';
            
            var url = path.indexOf('http') === 0 ? path : '';
            var urlParam = url ? '?url=' + encodeURIComponent(url) : '?url=' + encodeURIComponent(path);
            
            ajax('GET', '/api/opds/browse' + urlParam, null, function(err, data) {
                if (err || !data) {
                    content.innerHTML = '<center>Error loading</center>';
                    return;
                }
                
                opdsData = data.entries || [];
                renderOPDSList(path);
            });
        }

        function renderOPDSList(currentPath) {
            var content = document.getElementById('opds-content');
            content.innerHTML = '';
            
            var back = document.createElement('div');
            back.className = 'opds-item';
            back.innerHTML = '<b>&larr; Back</b>';
            back.onclick = function() {
                if (opdsHistory.length === 0) {
                    renderOPDSMenu();
                } else {
                    var prev = opdsHistory.pop();
                    browseOPDS(prev);
                }
            };
            content.appendChild(back);
            
            // Check if this is an author page (has books with acquisition links)
            var hasBooks = false;
            for (var i = 0; i < opdsData.length; i++) {
                for (var j = 0; j < opdsData[i].links.length; j++) {
                    if (opdsData[i].links[j].rel && opdsData[i].links[j].rel.indexOf('acquisition') !== -1) {
                        hasBooks = true;
                        break;
                    }
                }
                if (hasBooks) break;
            }
            
            if (hasBooks) {
                renderAuthorDrilldown();
                return;
            }
            
            // Regular navigation list
            for (var i = 0; i < opdsData.length; i++) {
                var entry = opdsData[i];
                var navLink = null;
                var acqLink = null;
                
                for (var j = 0; j < entry.links.length; j++) {
                    var link = entry.links[j];
                    if (link.rel && link.rel.indexOf('subsection') !== -1) {
                        navLink = link;
                    }
                    if (link.rel && link.rel.indexOf('acquisition') !== -1) {
                        acqLink = link;
                    }
                }
                
                var div = document.createElement('div');
                div.className = 'opds-item';
                
                if (navLink) {
                    div.innerHTML = '<b>' + entry.title + '</b>';
                    div.onclick = (function(path, href) {
                        return function() {
                            opdsHistory.push(path);
                            browseOPDS(href);
                        };
                    })(currentPath, navLink.href);
                } else if (acqLink) {
                    var seriesInfo = '';
                    if (entry.series_name) {
                        seriesInfo = '<br><small>' + entry.series_name + ' #' + (entry.series_index || '?') + '</small>';
                    }
                    div.innerHTML = '<b>' + entry.title + '</b>' + 
                        '<br><small>' + (entry.author || 'Unknown') + '</small>' + 
                        seriesInfo +
                        '<br><button class="btn" style="margin-top:10px; padding:8px;" onclick="sendToKindle(\'' + acqLink.href.replace(/'/g, "\\'") + '\'); event.stopPropagation();">Send to Kindle</button>';
                    div.onclick = null;
                }
                
                content.appendChild(div);
            }
        }

        function renderAuthorDrilldown() {
            var content = document.getElementById('opds-content');
            
            // Collect all unique series
            var seriesMap = {};
            var standaloneBooks = [];
            
            for (var i = 0; i < opdsData.length; i++) {
                var book = opdsData[i];
                if (book.series_name) {
                    if (!seriesMap[book.series_name]) {
                        seriesMap[book.series_name] = [];
                    }
                    seriesMap[book.series_name].push(book);
                } else {
                    standaloneBooks.push(book);
                }
            }
            
            // Show series folders
            var seriesNames = [];
            for (var name in seriesMap) {
                if (seriesMap.hasOwnProperty(name)) {
                    seriesNames.push(name);
                }
            }
            seriesNames.sort();
            
            for (var i = 0; i < seriesNames.length; i++) {
                var sName = seriesNames[i];
                var div = document.createElement('div');
                div.className = 'opds-item';
                div.innerHTML = '<b>ðŸ“š Series: ' + sName + '</b> <small>(' + seriesMap[sName].length + ' books)</small>';
                div.onclick = (function(name, books) {
                    return function() {
                        renderSeriesBooks(name, books);
                    };
                })(sName, seriesMap[sName]);
                content.appendChild(div);
            }
            
            // Show standalone folder
            if (standaloneBooks.length > 0) {
                var div = document.createElement('div');
                div.className = 'opds-item';
                div.innerHTML = '<b>ðŸ“„ Standalone Books</b> <small>(' + standaloneBooks.length + ' books)</small>';
                div.onclick = function() {
                    renderStandaloneBooks(standaloneBooks);
                };
                content.appendChild(div);
            }
            
            // Show all books option
            var div = document.createElement('div');
            div.className = 'opds-item';
            div.innerHTML = '<b>ðŸ“– All Books</b> <small>(' + opdsData.length + ' books)</small>';
            div.onclick = function() {
                renderAllBooks(opdsData);
            };
            content.appendChild(div);
        }

        function renderSeriesBooks(seriesName, books) {
            var content = document.getElementById('opds-content');
            content.innerHTML = '';
            
            var back = document.createElement('div');
            back.className = 'opds-item';
            back.innerHTML = '<b>&larr; Back</b>';
            back.onclick = function() {
                renderOPDSList(opdsHistory[opdsHistory.length - 1] || '');
            };
            content.appendChild(back);
            
            var header = document.createElement('div');
            header.className = 'section-header';
            header.innerText = seriesName;
            content.appendChild(header);
            
            // Sort by series index
            books.sort(function(a, b) {
                return (parseFloat(a.series_index) || 0) - (parseFloat(b.series_index) || 0);
            });
            
            for (var i = 0; i < books.length; i++) {
                renderBookItem(books[i]);
            }
        }

        function renderStandaloneBooks(books) {
            var content = document.getElementById('opds-content');
            content.innerHTML = '';
            
            var back = document.createElement('div');
            back.className = 'opds-item';
            back.innerHTML = '<b>&larr; Back</b>';
            back.onclick = function() {
                renderOPDSList(opdsHistory[opdsHistory.length - 1] || '');
            };
            content.appendChild(back);
            
            var header = document.createElement('div');
            header.className = 'section-header';
            header.innerText = 'Standalone Books';
            content.appendChild(header);
            
            for (var i = 0; i < books.length; i++) {
                renderBookItem(books[i]);
            }
        }

        function renderAllBooks(books) {
            var content = document.getElementById('opds-content');
            content.innerHTML = '';
            
            var back = document.createElement('div');
            back.className = 'opds-item';
            back.innerHTML = '<b>&larr; Back</b>';
            back.onclick = function() {
                renderOPDSList(opdsHistory[opdsHistory.length - 1] || '');
            };
            content.appendChild(back);
            
            var header = document.createElement('div');
            header.className = 'section-header';
            header.innerText = 'All Books';
            content.appendChild(header);
            
            // Sort by title
            books.sort(function(a, b) {
                return a.title.localeCompare(b.title);
            });
            
            for (var i = 0; i < books.length; i++) {
                renderBookItem(books[i]);
            }
        }

        function renderBookItem(book) {
            var content = document.getElementById('opds-content');
            var acqLink = null;
            var thumbnail = '';
            
            for (var j = 0; j < book.links.length; j++) {
                if (book.links[j].rel && book.links[j].rel.indexOf('acquisition') !== -1) {
                    acqLink = book.links[j];
                }
                if (book.links[j].rel && book.links[j].rel.indexOf('thumbnail') !== -1) {
                    thumbnail = book.links[j].href;
                }
            }
            
            if (!acqLink) return;
            
            var div = document.createElement('div');
            div.className = 'opds-item';
            div.style.cursor = 'default';
            
            var seriesInfo = '';
            if (book.series_name) {
                seriesInfo = '<br><small style="color:#666;">' + book.series_name + ' #' + (book.series_index || '?') + '</small>';
            }
            
            var description = '';
            if (book.description) {
                description = '<div class="book-description">' + book.description + '</div>';
            }
            
            var coverHtml = '<div class="book-cover">';
            if (thumbnail) {
                coverHtml += '<img src="' + thumbnail + '" onerror="this.src=\'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTgwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZWVlIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5OTkiIGZvbnQtc2l6ZT0iMTQiPk5vIENvdmVyPC90ZXh0Pjwvc3ZnPg==\';">';
            } else {
                coverHtml += '<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTgwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZWVlIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5OTkiIGZvbnQtc2l6ZT0iMTQiPk5vIENvdmVyPC90ZXh0Pjwvc3ZnPg==">';
            }
            coverHtml += '<button class="btn" onclick="sendToKindle(\'' + acqLink.href.replace(/'/g, "\\'") + '\'); event.stopPropagation();">Send to Kindle</button></div>';
            
            div.innerHTML = '<div class="book-row">' + coverHtml +
                '<div class="book-info">' +
                '<b>' + book.title + '</b>' + seriesInfo + description +
                '</div></div>';
            
            content.appendChild(div);
        }

        function sendToKindle(url) {
            showToast('Sending...');
            ajax('POST', '/api/opds/send-to-kindle', {url: url}, function(err, res) {
                if (err) {
                    showToast('Error: ' + err);
                } else {
                    showToast('Sent to Kindle!');
                }
            });
        }

        function performSearch() {
            var query = document.getElementById('search-input').value;
            if (!query) return;
            
            var results = document.getElementById('search-results');
            results.innerHTML = '<center>Searching...</center>';
            
            ajax('GET', '/api/ephemera/search?q=' + encodeURIComponent(query), null, function(err, data) {
                results.innerHTML = '';
                
                if (err || !data) {
                    results.innerHTML = '<center>Error</center>';
                    return;
                }
                
                if (data.error) {
                    results.innerHTML = '<center>' + data.error + '</center>';
                    return;
                }
                
                if (!data.length) {
                    results.innerHTML = '<center>No results</center>';
                    return;
                }
                
                for (var i = 0; i < data.length; i++) {
                    var book = data[i];
                    var div = document.createElement('div');
                    div.className = 'book-card';
                    div.style.cursor = 'default';
                    
                    var authors = book.authors ? book.authors.join(', ') : 'Unknown';
                    var sizeInMB = book.size ? (book.size / 1024 / 1024).toFixed(1) + ' MB' : 'Unknown size';
                    
                    var coverHtml = '<div class="book-cover">';
                    if (book.coverUrl) {
                        coverHtml += '<img src="' + book.coverUrl + '" onerror="this.src=\'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTgwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZWVlIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5OTkiIGZvbnQtc2l6ZT0iMTQiPk5vIENvdmVyPC90ZXh0Pjwvc3ZnPg==\';">';
                    } else {
                        coverHtml += '<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTgwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZWVlIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5OTkiIGZvbnQtc2l6ZT0iMTQiPk5vIENvdmVyPC90ZXh0Pjwvc3ZnPg==">';
                    }
                    coverHtml += '<button class="btn" onclick="addBook(\'' + book.md5 + '\')">Add to Queue</button>';
                    coverHtml += '</div>';
                    
                    div.innerHTML = '<div class="book-row">' + coverHtml +
                        '<div class="book-info">' +
                        '<b>' + book.title + '</b>' +
                        '<br><small style="color:#666;">' + authors + '</small>' +
                        '<br><small style="color:#666;">Language: ' + (book.language || 'Unknown') + ' â€¢ Size: ' + sizeInMB + '</small>' +
                        '</div></div>';
                    
                    results.appendChild(div);
                }
            });
        }

        function addBook(md5) {
            ajax('POST', '/api/ephemera/download', {md5: md5, title: ''}, function(err, res) {
                if (!err) showToast('Queued');
            });
        }

        function refreshQueue() {
            if (currentTab !== 'queue') return;
            
            var list = document.getElementById('queue-list');
            list.innerHTML = '<center>Loading...</center>';
            
            ajax('GET', '/api/ephemera/queue', null, function(err, res) {
                list.innerHTML = '';
                
                if (err || !res) {
                    list.innerHTML = '<center>Error</center>';
                    return;
                }
                
                if (res.error && typeof res.error === 'string') {
                    list.innerHTML = '<center>' + res.error + '</center>';
                    return;
                }
                
                var allItems = [];
                var categories = ['queued', 'downloading', 'done', 'error', 'delayed', 'cancelled', 'available'];
                
                for (var i = 0; i < categories.length; i++) {
                    var cat = categories[i];
                    if (res[cat]) {
                        for (var md5 in res[cat]) {
                            if (res[cat].hasOwnProperty(md5)) {
                                var item = res[cat][md5];
                                item.status = cat;
                                allItems.push(item);
                            }
                        }
                    }
                }
                
                if (allItems.length === 0) {
                    list.innerHTML = '<center>Queue empty</center>';
                    return;
                }

                for (var i = 0; i < allItems.length; i++) {
                    var item = allItems[i];
                    var div = document.createElement('div');
                    div.className = 'queue-item';
                    div.innerHTML = '<b>' + (item.title || item.filename || 'Unknown') + '</b><br>' +
                        '<small>Status: ' + item.status + '</small>';
                    list.appendChild(div);
                }
            });
        }

        function searchBSIOAuthorsInRequest() {
            var query = document.getElementById('bsio-search-input').value;
            if (!query) return;

            var results = document.getElementById('bsio-results');
            results.innerHTML = '<center>Searching...</center>';

            ajax('GET', '/api/bookseriesinorder/search?q=' + encodeURIComponent(query), null, function(err, data) {
                results.innerHTML = '';

                if (err || !data) {
                    results.innerHTML = '<center>Error searching</center>';
                    return;
                }

                if (data.error) {
                    results.innerHTML = '<center>' + data.error + '</center>';
                    return;
                }

                if (!data.length) {
                    results.innerHTML = '<center>No authors found</center>';
                    return;
                }

                showBSIOAuthorListInRequest(data);
            });
        }

        function showBSIOAuthorListInRequest(authors) {
            var results = document.getElementById('bsio-results');
            results.innerHTML = '';

            var header = document.createElement('div');
            header.className = 'section-header';
            header.innerText = 'Authors Found (' + authors.length + ')';
            results.appendChild(header);

            for (var i = 0; i < authors.length; i++) {
                var author = authors[i];
                var div = document.createElement('div');
                div.className = 'opds-item';

                var html = '<b>' + author.name + '</b>';
                if (author.description) {
                    html += '<br><small style="color:#666;">' + author.description + '</small>';
                }

                div.innerHTML = html;
                div.onclick = (function(url, name) {
                    return function() {
                        showBSIOAuthorBooksInRequest(url, name);
                    };
                })(author.url, author.name);

                results.appendChild(div);
            }
        }

        function showBSIOAuthorBooksInRequest(authorUrl, authorName) {
            var container = document.getElementById('bsio-search-container');
            container.innerHTML = '<center>Loading...</center>';

            ajax('GET', '/api/bookseriesinorder/author?url=' + encodeURIComponent(authorUrl), null, function(err, data) {
                if (err || !data) {
                    container.innerHTML = '<center>Error loading author books</center>';
                    return;
                }

                if (data.error) {
                    container.innerHTML = '<center>' + data.error + '</center>';
                    return;
                }

                container.innerHTML = '';

                var back = document.createElement('div');
                back.className = 'opds-item';
                back.innerHTML = '<b>&larr; Back</b>';
                back.onclick = function() {
                    showBSIOSearchInRequest();
                };
                container.appendChild(back);

                var header = document.createElement('div');
                header.className = 'section-header';
                header.innerText = data.author || authorName;
                container.appendChild(header);

                if (!data.series || data.series.length === 0) {
                    var noBooks = document.createElement('p');
                    noBooks.style.textAlign = 'center';
                    noBooks.style.color = '#666';
                    noBooks.innerText = 'No series found for this author';
                    container.appendChild(noBooks);
                    return;
                }

                // Collect all book titles to check library status
                var allTitles = [];
                for (var i = 0; i < data.series.length; i++) {
                    for (var j = 0; j < data.series[i].books.length; j++) {
                        allTitles.push(data.series[i].books[j].title);
                    }
                }

                console.log('[BSIO] Checking library for ' + allTitles.length + ' books, author: ' + (data.author || authorName));

                // Check library status
                ajax('POST', '/api/opds/check-library', {titles: allTitles, author: data.author || authorName}, function(libErr, libData) {
                    console.log('[BSIO] Library check response - error:', libErr, 'data:', libData);
                    var libraryStatus = {};
                    if (!libErr && libData && libData.results) {
                        libraryStatus = libData.results;
                        console.log('[BSIO] Library status:', libraryStatus);
                    }

                    // Render series with library status
                    for (var i = 0; i < data.series.length; i++) {
                        var series = data.series[i];

                        var seriesHeader = document.createElement('div');
                        seriesHeader.style.fontSize = '28px';
                        seriesHeader.style.fontWeight = 'bold';
                        seriesHeader.style.marginTop = '20px';
                        seriesHeader.style.marginBottom = '10px';
                        seriesHeader.innerHTML = series.name + ' <small style="color:#666;">(' + series.books.length + ' books)</small>';
                        container.appendChild(seriesHeader);

                        for (var j = 0; j < series.books.length; j++) {
                            var book = series.books[j];
                            var bookDiv = document.createElement('div');
                            bookDiv.className = 'opds-item';
                            bookDiv.style.cursor = 'default';
                            bookDiv.style.padding = '10px';

                            var bookHtml = '<b>' + book.title + '</b><br>';

                            // Check library status (it's now an object with in_library property)
                            var libStatus = libraryStatus[book.title] || {in_library: false};
                            var inLibrary = libStatus.in_library || false;

                            if (inLibrary) {
                                bookHtml += '<small style="color:#0a0; font-weight:bold;">IN LIBRARY';
                                if (libStatus.match_score && libStatus.match_score < 100) {
                                    bookHtml += ' (' + libStatus.match_score + '% match)';
                                }
                                bookHtml += '</small> ';

                                // Show "Send to EReader" button for books in library
                                if (libStatus.download_url) {
                                    bookHtml += '<button class="btn" style="display:inline-block; width:auto; padding:8px 15px; margin-left:10px; font-size:18px; background:#0a0;" onclick="sendToKindle(\'' + libStatus.download_url.replace(/'/g, "\\'") + '\'); event.stopPropagation();">Send to EReader</button>';
                                }
                            } else {
                                bookHtml += '<small style="color:#666;">NOT IN LIBRARY</small> ';

                                // Show "Search Ephemera" button for books not in library
                                var searchQuery = (data.author || authorName) + ' ' + book.title;
                                // Remove text in parentheses from search query
                                searchQuery = searchQuery.replace(/\([^)]*\)/g, '').replace(/\s+/g, ' ').trim();
                                bookHtml += '<button class="btn" style="display:inline-block; width:auto; padding:8px 15px; margin-left:10px; font-size:18px;" onclick="searchEphemeraFor(\'' + searchQuery.replace(/'/g, "\\'") + '\'); event.stopPropagation();">Search Ephemera</button>';
                            }

                            if (book.amazon_link) {
                                bookHtml += '<br><a href="' + book.amazon_link + '" target="_blank" style="color:#666; font-size:18px; margin-top:5px; display:inline-block;">View on Amazon</a>';
                            }

                            bookDiv.innerHTML = bookHtml;
                            container.appendChild(bookDiv);
                        }
                    }
                });
            });
        }

        function searchEphemeraFor(query) {
            // Switch to Request tab, then to Ephemera search
            switchTab('search');
            showEphemeraSearch();

            // Set the search query and trigger search
            document.getElementById('search-input').value = query;
            performSearch();
        }

        loadSettings();
        renderOPDSMenu();
    </script>
</body>
</html>

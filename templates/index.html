<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BookStack</title>
    <style>
        /* RESET & VIEWPORT */
        * {
            box-sizing: border-box;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            font-family: sans-serif;
            background: #ffffff;
            color: #000000;
            font-size: 20px;
        }

        #app-layout {
            display: table;
            width: 100%;
            height: 100%;
            border-collapse: collapse;
        }

        .layout-row {
            display: table-row;
        }

        #top-nav-cell {
            height: 45px;
            border-bottom: 2px solid #000;
            background: #fff;
            vertical-align: middle;
            text-align: center;
        }

        #context-bar-cell {
            height: 45px;
            border-bottom: 2px solid #000;
            background: #fff;
            vertical-align: middle;
        }

        #content-area-cell {
            height: 100%;
            vertical-align: top;
            padding: 5px;
        }

        .nav-table {
            width: 100%;
            border-collapse: collapse;
        }

        .nav-table td {
            width: 25%;
            text-align: center;
        }

        .ctx-table {
            width: 100%;
            border-collapse: collapse;
        }

        .ctx-left,
        .ctx-right {
            width: 25%;
        }

        .ctx-center {
            width: 50%;
            text-align: center;
            font-weight: bold;
            white-space: nowrap;
            overflow: hidden;
        }

        .nav-link {
            display: block;
            text-decoration: none;
            color: #000;
            font-weight: bold;
            font-size: 20px;
            padding: 10px 0;
            text-transform: uppercase;
            border: 2px solid transparent;
        }

        .nav-link.active {
            border-bottom: 4px solid #000;
        }

        .btn {
            background: #fff;
            color: #000;
            border: 2px solid #000;
            font-weight: bold;
            font-size: 18px;
            padding: 5px 10px;
            text-transform: uppercase;
            cursor: pointer;
            border-radius: 0;
            min-height: 35px;
            display: inline-block;
            appearance: none;
            -webkit-appearance: none;
        }

        .btn:active {
            background: #000;
            color: #fff;
        }

        .btn:disabled {
            border-color: #999;
            color: #999;
        }

        .opds-item {
            border: 1px solid #000;
            margin-bottom: 4px;
            padding: 4px;
            background: #fff;
            display: block;
            overflow: hidden;
            width: 100%;
        }

        .book-row {
            border: 1px solid #000;
            margin-bottom: 4px;
            padding: 4px;
            background: #fff;
            display: table;
            table-layout: fixed;
            height: 110px;
            overflow: hidden;
            width: 100%;
        }

        .book-cover {
            display: table-cell;
            vertical-align: top;
            width: 70px;
            padding-right: 5px;
        }

        .book-info {
            display: table-cell;
            vertical-align: top;
            height: 100%;
            overflow: hidden;
        }

        .book-cover img {
            width: 60px;
            height: 90px;
            border: 1px solid #000;
            display: block;
            margin: 0;
            cursor: pointer;
        }

        .book-title {
            font-weight: bold;
            font-size: 20px;
            line-height: 1.0;
            margin: 0 0 1px 0;
            height: 40px;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .book-title a {
            color: #000;
            text-decoration: none;
            display: block;
            margin: 0;
            padding: 0;
            line-height: 1.0;
        }

        .book-description {
            margin: 0;
            padding: 0;
            font-size: 18px;
            line-height: 20px;
            color: #333;
            overflow: hidden;
            height: 50px;
            display: block;
        }

        .book-description a {
            color: #333;
            text-decoration: none;
            display: block;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            z-index: 9999;
            display: none;
            padding: 20px;
            border: 5px solid #000;
        }

        .modal-content {
            height: 80%;
            overflow-y: scroll;
            font-size: 24px;
            border-bottom: 2px solid #000;
            margin-bottom: 10px;
        }

        input[type="text"] {
            width: 100%;
            border: 2px solid #000;
            padding: 8px;
            font-size: 20px;
            border-radius: 0;
            margin-bottom: 5px;
            box-sizing: border-box;
        }

        .hidden {
            display: none !important;
        }

        #message-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #000;
            color: #fff;
            padding: 10px 20px;
            z-index: 10000;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <table id="app-layout">
        <tr class="layout-row">
            <td id="top-nav-cell">
                <table class="nav-table">
                    <tr>
                        <td><button type="button" class="nav-link active" onclick="switchTab('cloud'); return false;"
                                style="background:none; border:none; width:100%;">Library</button></td>
                        <td><button type="button" class="nav-link" onclick="switchTab('search'); return false;"
                                style="background:none; border:none; width:100%;">Request</button></td>
                        <td><button type="button" class="nav-link" onclick="switchTab('queue'); return false;"
                                style="background:none; border:none; width:100%;">Queue</button></td>
                        <td><button type="button" class="nav-link" onclick="switchTab('settings'); return false;"
                                style="background:none; border:none; width:100%;">Tools</button></td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr class="layout-row">
            <td id="context-bar-cell">
                <table class="ctx-table">
                    <tr>
                        <td id="ctx-left" class="ctx-left"></td>
                        <td id="ctx-center" class="ctx-center">Library</td>
                        <td id="ctx-right" class="ctx-right"></td>
                    </tr>
                </table>
            </td>
        </tr>
        <tr class="layout-row">
            <td id="content-area-cell">
                <div id="content-area" style="height:100%; overflow:hidden; position:relative;">
                    <div id="view-cloud">
                        <div id="opds-content">Loading...</div>
                    </div>
                    <div id="view-search" class="hidden">
                        <div id="search-input-container" class="card"
                            style="padding: 5px; border-bottom: 1px solid #000;">
                            <input type="text" id="search-input" placeholder="Search Title..."
                                onkeypress="if(event.keyCode==13) performSearch()">
                            <button type="button" class="btn" style="width:100%"
                                onclick="performSearch()">SEARCH</button>
                        </div>
                        <div id="search-results"></div>
                    </div>
                    <div id="view-queue" class="hidden">
                        <div id="queue-list"></div>
                    </div>
                    <div id="view-settings" class="hidden">
                        <div class="card" style="padding:10px;">
                            <h3>Kindle Settings</h3>
                            <p>Enter your "Send to Kindle" email address:</p>
                            <input type="text" id="kindle-email" placeholder="example@kindle.com">
                            <button type="button" class="btn" style="width:100%; margin-top:10px;"
                                onclick="saveSettings()">SAVE
                                SETTINGS</button>
                        </div>
                    </div>
                    <div id="bsio-search-container" class="hidden"></div>
                    <div id="releases-container" class="hidden"></div>
                </div>
            </td>
        </tr>
    </table>

    <div id="desc-modal" class="modal-overlay">
        <div class="modal-content" id="modal-text"></div>
        <button type="button" class="btn" style="width:100%; height: 50px;" onclick="closeModal()">CLOSE</button>
    </div>

    <div id="confirm-modal" class="modal-overlay" style="display:none;">
        <div style="text-align:center; padding-top:20px;">
            <p id="confirm-text" style="font-size:24px; font-weight:bold; margin-bottom:20px;">Send to Kindle?</p>
            <button type="button" id="confirm-yes-btn" class="btn" onclick="sendConfirmToKindle()"
                style="width:100%; height: 50px; margin-bottom:10px; background:#000; color:#fff;">SEND</button>
            <button type="button" class="btn" style="width:100%; height: 50px;"
                onclick="closeConfirmModal()">CANCEL</button>
        </div>
    </div>

    <div id="message-toast" class="hidden"></div>

    <script>
        // Global State
        window.confirmUrl = null;
        var currentTab = 'cloud';
        var opdsHistory = [];
        var opdsData = [];
        var opdsType = 'navigation';
        var paginationState = {
            items: [],
            currentPage: 0,
            pageSize: 10,
            title: '',
            backAction: null,
            itemRenderer: null,
            targetId: 'opds-content',
            footerRenderer: null
        };
        var searchStateBackup = null;

        // --- Core Functions ---

        function cleanString(s) {
            if (s === null || s === undefined) return '';
            var str = String(s).trim();
            var changed = true;
            while (changed) {
                changed = false;
                var lower = str.toLowerCase();
                if (lower.indexOf('undefined') === 0) { str = str.substring(9).trim(); changed = true; }
                else if (lower.indexOf('null') === 0) { str = str.substring(4).trim(); changed = true; }
            }
            if (str.toLowerCase() === 'undefined' || str.toLowerCase() === 'null') return '';
            return str;
        }

        function ajax(method, path, data, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open(method, path, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try { callback(null, JSON.parse(xhr.responseText)); } catch (e) { callback(null, null); }
                    } else {
                        try { var err = JSON.parse(xhr.responseText); callback(err.error || 'Error', null); }
                        catch (e) { callback('Error', null); }
                    }
                }
            };
            xhr.send(data ? JSON.stringify(data) : null);
        }

        function showToast(msg) {
            var toast = document.getElementById('message-toast');
            toast.innerText = msg;
            toast.className = '';
            setTimeout(function () { toast.className = 'hidden'; }, 3000);
        }

        // --- Navigation ---

        function switchTab(tab) {
            currentTab = tab;
            var tabs = ['cloud', 'search', 'queue', 'settings'];
            for (var i = 0; i < tabs.length; i++) {
                var view = document.getElementById('view-' + tabs[i]);
                if (view) view.className = 'hidden';
            }
            // Also hide these special containers
            document.getElementById('releases-container').className = 'hidden';
            document.getElementById('bsio-search-container').className = 'hidden';

            var selectedView = document.getElementById('view-' + tab);
            if (selectedView) selectedView.className = '';

            var links = document.querySelectorAll('.nav-link');
            for (var j = 0; j < links.length; j++) {
                links[j].className = 'nav-link';
            }
            if (tab === 'cloud') links[0].className += ' active';
            if (tab === 'search') links[1].className += ' active';
            if (tab === 'queue') links[2].className += ' active';
            if (tab === 'settings') links[3].className += ' active';

            if (tab === 'cloud') renderOPDSMenu();
            if (tab === 'search') {
                // Reset search view on tab click
                document.getElementById('search-input').value = '';
                document.getElementById('search-results').innerHTML = '';
                document.getElementById('search-input-container').className = 'card';
                window.searchResultRegistry = [];
                updateContextBar();
                document.getElementById('ctx-center').innerText = 'Request';
            }
            if (tab === 'queue') refreshQueue();
            if (tab === 'settings') loadSettings();
        }

        function sendToKindle(url) {
            if (!url) return;
            showToast('Sending to Kindle...');
            ajax('POST', '/api/opds/send-to-kindle', { url: url }, function (err, res) {
                if (!err) showToast('Queued!');
                else alert("Error: " + err);
            });
        }

        // --- Pagination Logic ---

        function calculatePageSize() {
            var container = document.getElementById('content-area');
            var height = container.clientHeight;
            var itemHeight = 150;
            return Math.max(1, Math.floor(height / itemHeight));
        }

        function updateContextBar() {
            var left = document.getElementById('ctx-left');
            var center = document.getElementById('ctx-center');
            var right = document.getElementById('ctx-right');

            left.innerHTML = ''; center.innerHTML = ''; right.innerHTML = '';
            center.innerText = paginationState.title || 'BookStack';

            if (paginationState.backAction) {
                var btn = document.createElement('button');
                btn.className = 'btn'; btn.innerHTML = '&lt; BACK';
                btn.onclick = paginationState.backAction;
                left.appendChild(btn);
            }

            var totalPages = Math.ceil(paginationState.items.length / paginationState.pageSize);
            if (totalPages > 1) {
                center.innerText += ' (' + (paginationState.currentPage + 1) + '/' + totalPages + ')';
                var prev = document.createElement('button');
                prev.className = 'btn'; prev.innerHTML = '&lt;'; prev.style.marginRight = '5px';
                prev.disabled = (paginationState.currentPage === 0);
                prev.onclick = function () { paginationState.currentPage--; renderCurrentPage(); };

                var next = document.createElement('button');
                next.className = 'btn'; next.innerHTML = '&gt;';
                next.disabled = (paginationState.currentPage >= totalPages - 1);
                next.onclick = function () { paginationState.currentPage++; renderCurrentPage(); };
                right.appendChild(prev); right.appendChild(next);
            }
        }

        function renderPaginatedList(title, items, itemRenderer, backAction, targetId, pageSize, footerRenderer) {
            paginationState.title = title;
            paginationState.items = items;
            paginationState.itemRenderer = itemRenderer;
            paginationState.backAction = backAction;
            paginationState.targetId = targetId || 'opds-content';
            paginationState.pageSize = pageSize || calculatePageSize();
            paginationState.currentPage = 0;
            paginationState.footerRenderer = footerRenderer;
            renderCurrentPage();
        }

        function renderCurrentPage() {
            var container = document.getElementById(paginationState.targetId);
            if (!container) return;
            container.innerHTML = '';
            updateContextBar();

            var start = paginationState.currentPage * paginationState.pageSize;
            var end = Math.min(start + paginationState.pageSize, paginationState.items.length);
            var pageItems = paginationState.items.slice(start, end);

            for (var i = 0; i < pageItems.length; i++) {
                var element = paginationState.itemRenderer(pageItems[i]);
                if (element) container.appendChild(element);
            }

            if (paginationState.footerRenderer) {
                paginationState.footerRenderer(container);
            }
        }

        // --- Library (OPDS) ---

        function renderOPDSMenu() {
            var content = document.getElementById('opds-content');
            content.innerHTML = '';
            opdsHistory = [];
            updateContextBar(); document.getElementById('ctx-center').innerText = 'Library';

            var intro = document.createElement('p');
            intro.innerText = 'Select a book from your library to download to Kindle.';
            intro.style.color = '#666'; content.appendChild(intro);

            var options = [
                { title: 'Recent Books', path: 'recent', isRecent: true },
                { title: 'Authors', path: '/authors' }
            ];

            for (var i = 0; i < options.length; i++) {
                (function (opt) {
                    var div = document.createElement('div'); div.className = 'opds-item';
                    div.innerHTML = '<b>' + opt.title + '</b>';
                    div.onclick = function () {
                        if (opt.isRecent) browseRecentBooks();
                        else browseOPDS(opt.path);
                    };
                    content.appendChild(div);
                })(options[i]);
            }
        }

        function browseRecentBooks() {
            var content = document.getElementById('opds-content');
            content.innerHTML = '<center>Loading...</center>';
            ajax('GET', '/api/opds/browse?url=' + encodeURIComponent('/recent?page=1&size=100'), null, function (err, data) {
                if (err || !data) { content.innerHTML = '<center>Error</center>'; return; }
                opdsData = data.entries || [];
                renderPaginatedList('Recent Books', opdsData, createBookItemDiv, renderOPDSMenu, 'opds-content', 4);
            });
        }

        function browseOPDS(path) {
            var content = document.getElementById('opds-content');
            content.innerHTML = '<center>Loading...</center>';
            var urlParam = '?url=' + encodeURIComponent(path);
            ajax('GET', '/api/opds/browse' + urlParam, null, function (err, data) {
                if (err || !data) { content.innerHTML = '<center>Error</center>'; return; }
                opdsData = data.entries || [];
                opdsType = data.type || 'navigation';
                renderOPDSList(path);
            });
        }

        function renderOPDSList(currentPath) {
            var seriesItems = []; var bookItems = [];
            for (var i = 0; i < opdsData.length; i++) {
                var entry = opdsData[i]; var isSeries = false; var isBook = false;
                if (entry.links) {
                    for (var j = 0; j < entry.links.length; j++) {
                        var rel = entry.links[j].rel || '';
                        if (rel.indexOf('subsection') !== -1) isSeries = true;
                        if (rel.indexOf('acquisition') !== -1) isBook = true;
                    }
                }
                if (isSeries) seriesItems.push(entry);
                else if (isBook) bookItems.push(entry);
            }

            var backAction = function () {
                if (opdsHistory.length > 0) browseOPDS(opdsHistory.pop());
                else renderOPDSMenu();
            };

            var pathLower = currentPath.toLowerCase();
            var isAuthorPath = pathLower.indexOf('author') !== -1;
            var segments = currentPath.split('/').filter(Boolean);

            // Adjust segment count logic for remote URLs vs local paths
            var pathDepth = segments.length;
            if (currentPath.indexOf('://') !== -1) pathDepth -= 2;

            // Author button only shows if we are drilled into an author's list
            // (e.g. /authors/A/AuthorName -> depth 3)
            var isAuthorLevel = isAuthorPath && (pathDepth >= 3);

            if (seriesItems.length > 0 || isAuthorLevel) {
                // Author/Series View
                seriesItems.sort(function (a, b) { return a.title.localeCompare(b.title); });
                var groups = {}; var standalones = []; var authorName = "";
                for (var i = 0; i < bookItems.length; i++) {
                    var b = bookItems[i];
                    if (!authorName) authorName = cleanString(b.author);
                    if (b.series_name) {
                        if (!groups[b.series_name]) groups[b.series_name] = [];
                        groups[b.series_name].push(b);
                    } else standalones.push(b);
                }

                var list = [];
                if (standalones.length > 0) list.push({ title: "[Standalone Books]", isSynthetic: true, books: standalones });
                var keys = Object.keys(groups).sort();
                for (var i = 0; i < keys.length; i++) list.push({ title: keys[i], isSynthetic: true, books: groups[keys[i]] });
                list = list.concat(seriesItems);

                renderPaginatedList(authorName || 'Authors', list, function (entry) {
                    var div = document.createElement('div'); div.className = 'opds-item';
                    div.innerHTML = '<b>' + (entry.title || entry.name || 'Unknown') + '</b>';
                    if (entry.isSynthetic) {
                        div.onclick = function () { renderPaginatedList(entry.title, entry.books, createBookItemDiv, function () { renderOPDSList(currentPath); }, 'opds-content', 4); };
                    } else {
                        var navLink = "";
                        for (var k = 0; k < entry.links.length; k++) if (entry.links[k].rel.indexOf('subsection') !== -1) navLink = entry.links[k].href;
                        div.onclick = function () { opdsHistory.push(currentPath); browseOPDS(navLink); };
                    }
                    return div;
                }, backAction, 'opds-content', 10, isAuthorLevel ? function (container) {
                    var btnDiv = document.createElement('center'); btnDiv.style.marginTop = '10px';
                    var btn = document.createElement('button'); btn.className = 'btn';
                    btn.type = 'button';
                    btn.innerText = "VIEW AUTHOR'S PUBLISHED BOOKS";
                    btn.onclick = function () { fetchScrapedBooks(authorName, currentPath); };
                    btnDiv.appendChild(btn); container.appendChild(btnDiv);
                } : null);
            } else {
                renderPaginatedList('Books', bookItems, createBookItemDiv, backAction, 'opds-content', 4);
            }
        }

        window.opdsBookRegistry = [];
        function createBookItemDiv(book) {
            var acq = null; var thumb = '';
            for (var i = 0; i < book.links.length; i++) {
                if (book.links[i].rel.indexOf('acquisition') !== -1) acq = book.links[i];
                if (book.links[i].rel.indexOf('thumbnail') !== -1) thumb = book.links[i].href;
            }
            if (!acq) return null;

            var div = document.createElement('div'); div.className = 'book-row';
            var title = book.title;
            var author = cleanString(book.author);
            var display = (author && title.indexOf(author) === -1) ? author + " | " + title : title;
            var idx = window.opdsBookRegistry.push(book) - 1;

            var coverHtml = '<div class="book-cover">';
            if (book._isScraped) {
                var btnBg = book._inLibrary ? "#90EE90" : "#FFA500";
                var btnTxt = book._inLibrary ? "SEND TO KINDLE" : "REQUEST BOOK";
                coverHtml += '<button type="button" class="btn" style="width:60px; height:90px; font-size:12px; background:' + btnBg + '" onclick="triggerOpdsAction(' + idx + '); event.stopPropagation();">' + btnTxt + '</button>';
            } else {
                var img = thumb || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iOTAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0iI2VlZSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjOTk5IiBmb250LXNpemU9IjEwIj5ObyBDb3ZlcjwvdGV4dD48L3N2Zz4=';
                coverHtml += '<img src="' + img + '" onclick="triggerOpdsAction(' + idx + ')">';
            }
            coverHtml += '</div>';

            var infoHtml = '<div class="book-info">';
            infoHtml += '<div class="book-title"><a href="javascript:void(0)" onclick="triggerOpdsAction(' + idx + ')">' + display + '</a></div>';
            if (book.description) {
                var safeDescIdx = idx; // Resuing reg for modal too if needed, but let's just use data-desc? 
                // Actually descriptions are long, safer to use reg.
                infoHtml += '<a href="javascript:void(0)" class="book-description" onclick="triggerShowDescription(' + idx + ')">' + book.description + '</a>';
            }
            infoHtml += '</div>';

            div.innerHTML = coverHtml + infoHtml;
            return div;
        }

        window.triggerOpdsAction = function (idx) {
            var book = window.opdsBookRegistry[idx];
            if (!book) return;
            var acq = null;
            for (var i = 0; i < book.links.length; i++) if (book.links[i].rel.indexOf('acquisition') !== -1) acq = book.links[i];

            var title = book.title;
            var author = cleanString(book.author);
            var display = (author && title.indexOf(author) === -1) ? author + " | " + title : title;

            if (book._isScraped && !book._inLibrary) {
                switchTab('search');
                document.getElementById('search-input').value = display;
                performSearch(display);
            } else {
                var url = book._libraryUrl || (acq ? acq.href : null);
                if (url) showConfirmModal(url, display);
            }
        };

        window.triggerShowDescription = function (idx) {
            var book = window.opdsBookRegistry[idx];
            if (book && book.description) showModal(book.description);
        };

        // --- Scraper ---

        function fetchScrapedBooks(name, backPath) {
            var content = document.getElementById('opds-content');
            content.innerHTML = '<center>Loading published books...</center>';
            var slug = name.toLowerCase().replace(/ /g, '-');
            var url = '/api/bookseriesinorder/author?url=' + encodeURIComponent('https://www.bookseriesinorder.com/' + slug + '/');
            ajax('GET', url, null, function (err, data) {
                if (err || !data || data.error) { alert("Error: " + (err || data.error)); browseOPDS(backPath); return; }
                renderScrapedView(data, backPath);
            });
        }

        function renderScrapedView(data, backPath) {
            var items = data.series || [];
            renderPaginatedList(data.author || 'Published Books', items, function (series) {
                var div = document.createElement('div'); div.className = 'opds-item';
                div.innerHTML = '<b>' + series.name + '</b> (' + (series.books ? series.books.length : 0) + ' books)';
                div.onclick = function () {
                    div.innerHTML = '<b>' + series.name + '</b> (Checking library...)';
                    var titles = series.books.map(function (b) { return b.title; });
                    ajax('POST', '/api/opds/check-library', { author: data.author, titles: titles }, function (err, lib) {
                        var res = (lib && lib.results) ? lib.results : {};
                        var mapped = series.books.map(function (b) {
                            var info = res[b.title] || { in_library: false };
                            return {
                                title: b.title, author: data.author, _isScraped: true,
                                _inLibrary: info.in_library, _libraryUrl: info.download_url,
                                links: [{ rel: 'acquisition', href: 'https://google.com/search?q=' + encodeURIComponent(data.author + ' ' + b.title) }]
                            };
                        });
                        renderPaginatedList(series.name, mapped, createBookItemDiv, function () { renderScrapedView(data, backPath); }, 'opds-content', 4);
                    });
                };
                return div;
            }, function () { browseOPDS(backPath); }, 'opds-content', 10);
        }

        // --- Request (Search) ---

        window.searchResultRegistry = [];
        window.releaseRegistry = [];

        function renderSearchMenu() {
            var menu = document.getElementById('search-menu');
            var ephemera = document.getElementById('ephemera-search');
            var bsio = document.getElementById('bsio-search-container');
            var releases = document.getElementById('releases-container');

            menu.className = ''; ephemera.className = 'hidden'; bsio.className = 'hidden'; releases.className = 'hidden';
            menu.innerHTML = '';
            document.getElementById('ctx-center').innerText = 'Request';
            document.getElementById('ctx-left').innerHTML = ''; document.getElementById('ctx-right').innerHTML = '';

            var options = [
                { title: 'Direct Search', desc: 'Search download sources directly', action: function () { menu.className = 'hidden'; ephemera.className = ''; } },
                { title: 'Series Search', desc: 'Search for series by author', action: showBSIOSearchMenu }
            ];

            for (var i = 0; i < options.length; i++) {
                (function (opt) {
                    var div = document.createElement('div'); div.className = 'opds-item';
                    div.innerHTML = '<b>' + opt.title + '</b><br><small style="color:#666">' + opt.desc + '</small>';
                    div.onclick = opt.action; menu.appendChild(div);
                })(options[i]);
            }
        }

        function performSearch(query) {
            var q = (query || document.getElementById('search-input').value || '').trim();
            if (!q) return;
            q = q.replace(/\|/g, ' ').replace(/\s+/g, ' ').trim();

            var results = document.getElementById('search-results');
            var inputDiv = document.getElementById('search-input-container');
            results.innerHTML = '<center>Searching...</center>';

            ajax('GET', '/api/ephemera/search?q=' + encodeURIComponent(q), null, function (err, data) {
                if (err || !data || !data.length) { results.innerHTML = '<center>No results</center>'; return; }
                inputDiv.className = 'hidden';
                window.searchResultRegistry = []; // Reset reg for new results
                renderPaginatedList('Results', data, createSearchResultDiv, function () {
                    inputDiv.className = 'card';
                    results.innerHTML = '';
                    // When clicking back from results, stay on search tab but show input
                    updateContextBar();
                }, 'search-results', 4);
            });
        }

        function createSearchResultDiv(item) {
            var div = document.createElement('div'); div.className = 'book-row';
            var authors = item.authors ? item.authors.join(', ') : 'Unknown';
            var idx = window.searchResultRegistry.push(item) - 1;

            var coverHtml = '<div class="book-cover"><img src="' + (item.coverUrl || '') + '" onclick="triggerShowReleases(' + idx + ')"></div>';
            var infoHtml = '<div class="book-info">';
            infoHtml += '<div class="book-title"><a href="javascript:void(0)" onclick="triggerShowReleases(' + idx + ')">' + item.title + '</a></div>';
            infoHtml += '<div class="book-meta">' + authors + '</div>';
            infoHtml += '</div>';

            div.innerHTML = coverHtml + infoHtml;
            return div;
        }

        window.triggerShowReleases = function (idx) {
            var item = window.searchResultRegistry[idx];
            if (item) showReleases(item.md5);
        };

        function showReleases(md5) {
            searchStateBackup = {
                items: paginationState.items, currentPage: paginationState.currentPage,
                pageSize: paginationState.pageSize, title: paginationState.title,
                backAction: paginationState.backAction, itemRenderer: paginationState.itemRenderer
            };

            document.getElementById('view-search').className = 'hidden';
            var container = document.getElementById('releases-container');
            container.className = ''; container.innerHTML = '<center>Loading releases...</center>';

            ajax('GET', '/api/ephemera/releases?md5=' + encodeURIComponent(md5), null, function (err, data) {
                if (err || !data || !data.length) { container.innerHTML = '<center>No releases</center><br><button type="button" class="btn" onclick="backToSearch()">BACK</button>'; return; }

                // Filter for Kindle-compatible formats (epub, mobi, azw3)
                var filtered = data.filter(function (r) {
                    var fmt = (r.format || '').toLowerCase();
                    return fmt === 'epub' || fmt === 'mobi' || fmt === 'azw3';
                });

                if (filtered.length === 0) {
                    container.innerHTML = '<center>No compatible formats (EPUB/MOBI/AZW3) found</center><br><button type="button" class="btn" onclick="backToSearch()">BACK</button>';
                    return;
                }

                renderPaginatedList('Select Release', filtered, createReleaseItemDiv, backToSearch, 'releases-container', 5);
            });
        }

        function backToSearch() {
            document.getElementById('releases-container').className = 'hidden';
            document.getElementById('view-search').className = '';
            if (searchStateBackup) {
                renderPaginatedList(searchStateBackup.title, searchStateBackup.items, searchStateBackup.itemRenderer, searchStateBackup.backAction, 'search-results', searchStateBackup.pageSize);
                paginationState.currentPage = searchStateBackup.currentPage; renderCurrentPage();
            }
        }

        function createReleaseItemDiv(r) {
            var div = document.createElement('div'); div.className = 'opds-item';
            var size = r.size_bytes ? (r.size_bytes / 1024 / 1024).toFixed(1) + 'MB' : (r.size || '');
            var idx = window.releaseRegistry.push(r) - 1;

            var title = r.title || r.filename || 'Unknown Title';

            var html = '<div style="float:right"><button type="button" class="btn" onclick="triggerDownload(' + idx + ')">GET</button></div>';
            html += '<b>' + title + '</b><br>';
            html += '<small>' + (r.format || '??').toUpperCase() + ' â€¢ ' + size + '</small>';
            div.innerHTML = html;
            return div;
        }

        window.triggerDownload = function (idx) {
            var r = window.releaseRegistry[idx];
            if (r) downloadRelease(r);
        };

        function downloadRelease(r) {
            showToast('Queuing download...');
            ajax('POST', '/api/ephemera/download', r, function (err, res) {
                if (!err) { showToast('Queued!'); backToSearch(); }
                else alert("Error: " + err);
            });
        }

        // --- BSIO Search ---

        function showBSIOSearchMenu() {
            document.getElementById('search-menu').className = 'hidden';
            var container = document.getElementById('bsio-search-container');
            container.className = ''; container.innerHTML = '';

            var back = document.createElement('div'); back.className = 'opds-item'; back.innerHTML = '<b>&larr; BACK</b>';
            back.onclick = renderSearchMenu; container.appendChild(back);

            var card = document.createElement('div'); card.style.padding = '10px';
            card.innerHTML = '<h3>Series Search</h3><input type="text" id="bsio-input" placeholder="Author name..."><button class="btn" style="width:100%" onclick="doBSIOSearch()">SEARCH</button>';
            container.appendChild(card);

            var results = document.createElement('div'); results.id = 'bsio-results';
            container.appendChild(results);
        }

        function doBSIOSearch() {
            var q = document.getElementById('bsio-input').value; if (!q) return;
            var results = document.getElementById('bsio-results');
            results.innerHTML = '<center>Searching...</center>';
            ajax('GET', '/api/bookseriesinorder/search?q=' + encodeURIComponent(q), null, function (err, data) {
                if (err || !data || !data.length) { results.innerHTML = '<center>No results</center>'; return; }
                renderPaginatedList('Authors', data, function (a) {
                    var div = document.createElement('div'); div.className = 'opds-item';
                    div.innerHTML = '<b>' + a.name + '</b><br><small>' + (a.description || '') + '</small>';
                    div.onclick = function () { fetchScrapedBooks(a.name, 'search'); };
                    return div;
                }, showBSIOSearchMenu, 'bsio-results', 10);
            });
        }

        // --- Queue ---

        function refreshQueue() {
            var list = document.getElementById('queue-list');
            list.innerHTML = '<center>Loading...</center>';
            ajax('GET', '/api/ephemera/queue', null, function (err, res) {
                list.innerHTML = '';
                if (err || !res) { list.innerHTML = '<center>Error</center>'; return; }
                var all = [];
                var cats = ['queued', 'downloading', 'done', 'error', 'delayed', 'cancelled', 'available'];
                for (var i = 0; i < cats.length; i++) {
                    var c = cats[i];
                    if (res[c]) for (var md5 in res[c]) { var item = res[c][md5]; item.status = c; all.push(item); }
                }
                if (all.length === 0) { list.innerHTML = '<center>Queue empty</center>'; return; }
                for (var i = 0; i < all.length; i++) {
                    var item = all[i];
                    var div = document.createElement('div'); div.className = 'opds-item';
                    var status = 'Status: ' + item.status;
                    if (item.status_message) status += '<br><small style="color:' + (item.status === 'error' ? 'red' : '#666') + '">' + item.status_message + '</small>';
                    div.innerHTML = '<b>' + (item.title || item.filename || 'Unknown') + '</b><br><small>' + status + '</small>';
                    list.appendChild(div);
                }
            });
        }

        // --- Settings ---

        function loadSettings() {
            ajax('GET', '/api/settings', null, function (err, data) {
                if (data) document.getElementById('kindle-email').value = data.kindle_email || '';
            });
        }

        function saveSettings() {
            var email = document.getElementById('kindle-email').value;
            ajax('POST', '/api/settings', { kindle_email: email }, function (err, res) {
                if (!err) showToast('Saved');
            });
        }

        // --- Modals ---

        function showModal(content) {
            document.getElementById('modal-text').innerHTML = content;
            document.getElementById('desc-modal').style.display = 'block';
        }

        function closeModal() { document.getElementById('desc-modal').style.display = 'none'; }

        function showConfirmModal(url, title) {
            window.confirmUrl = url;
            document.getElementById('confirm-text').innerHTML = "Send '" + title + "' to Kindle?";
            document.getElementById('confirm-modal').style.display = 'block';
        }

        function closeConfirmModal() { document.getElementById('confirm-modal').style.display = 'none'; }

        function sendConfirmToKindle() {
            if (window.confirmUrl) sendToKindle(window.confirmUrl);
            closeConfirmModal();
        }

        // --- Init ---
        switchTab('cloud');
    </script>
</body>

</html>
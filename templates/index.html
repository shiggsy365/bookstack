<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kobo Library</title>
    <style>
        body { font-family: sans-serif; background: #f0f0f0; margin: 0; padding: 0; font-size: 24px; }
        .header { background: #fff; border-bottom: 2px solid #000; padding: 15px; text-align: center; font-size: 36px; font-weight: bold; }
        .nav { background: #fff; border-bottom: 1px solid #000; }
        .nav a { display: inline-block; padding: 15px; text-decoration: none; color: #666; font-weight: bold; width: 24%; text-align: center; box-sizing: border-box; font-size: 24px; }
        .nav a.active { color: #000; border-bottom: 3px solid #000; }
        .container { padding: 15px; }
        .card { background: #fff; border: 1px solid #000; padding: 15px; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; border: 1px solid #ccc; margin-bottom: 10px; box-sizing: border-box; font-size: 24px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 21px; text-transform: uppercase; }
        .book-card { background: #fff; border: 1px solid #000; padding: 15px; margin-bottom: 10px; font-size: 24px; }
        .btn { background: #000; color: #fff; border: none; padding: 12px 20px; cursor: pointer; font-size: 24px; width: 100%; font-weight: bold; }
        .queue-item { background: #fff; border: 1px solid #000; padding: 10px; margin-bottom: 5px; font-size: 24px; }
        .hidden { display: none; }
        #message-toast { position: fixed; bottom: 20px; left: 50%; margin-left: -100px; background: #333; color: #fff; padding: 10px 20px; width: 200px; text-align: center; font-size: 24px; }
        .opds-item { background: #fff; border: 1px solid #000; padding: 15px; margin-bottom: 10px; cursor: pointer; font-size: 24px; }
        .opds-item:hover { background: #f5f5f5; }
        .book-row { display: table; width: 100%; }
        .book-cover { display: table-cell; width: 140px; vertical-align: top; padding-right: 15px; }
        .book-cover img { width: 140px; height: 210px; border: 1px solid #ccc; object-fit: cover; display: block; margin-bottom: 10px; }
        .book-info { display: table-cell; vertical-align: top; }
        .book-description { margin-top: 8px; color: #555; font-size: 21px; line-height: 1.4; }
        p { font-size: 24px; line-height: 1.4; }
        .section-header { font-size: 30px; font-weight: bold; padding: 15px 0; }
        small { font-size: 21px; }
    </style>
</head>
<body>
    <div class="header"><b>Cloud Library</b></div>
    
    <div class="nav">
        <a href="#" id="tab-cloud-btn" class="active" onclick="switchTab('cloud'); return false;">Library</a>
        <a href="#" id="tab-search-btn" onclick="switchTab('search'); return false;">Request</a>
        <a href="#" id="tab-queue-btn" onclick="switchTab('queue'); return false;">Queue</a>
        <a href="#" id="tab-settings-btn" onclick="switchTab('settings'); return false;">...</a>
    </div>

    <div class="container">
        <div id="view-cloud">
            <div id="opds-content"></div>
        </div>

        <div id="view-search" class="hidden">
            <div class="card">
                <p style="margin-top:0; color:#666;">Search for a book to add to the Cloud Library</p>
                <input type="text" id="search-input" placeholder="Search Ephemera...">
                <button class="btn" onclick="performSearch()">Search</button>
            </div>
            <div id="search-results"></div>
        </div>

        <div id="view-queue" class="hidden">
            <p style="margin:0 0 15px 0; color:#666;">Requested books will appear in the cloud library when marked as complete below</p>
            <div id="queue-list"></div>
        </div>

        <div id="view-settings" class="hidden">
            <div class="card">
                <label>Send to Kindle Email</label>
                <input type="email" id="kindle-email" placeholder="username@kindle.com">
                <button class="btn" onclick="saveSettings()">Save</button>
            </div>
        </div>
    </div>

    <div id="message-toast" class="hidden"></div>

    <script>
        var currentTab = 'cloud';
        var opdsHistory = [];
        var opdsData = [];

        function showToast(msg) {
            var toast = document.getElementById('message-toast');
            toast.innerText = msg;
            toast.className = '';
            setTimeout(function() { toast.className = 'hidden'; }, 3000);
        }

        function ajax(method, path, data, callback) {
            var xhr = new XMLHttpRequest();
            xhr.open(method, path, true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4) {
                    if (xhr.status >= 200 && xhr.status < 300) {
                        try {
                            callback(null, JSON.parse(xhr.responseText));
                        } catch (e) {
                            callback(null, null);
                        }
                    } else {
                        try {
                            var err = JSON.parse(xhr.responseText);
                            callback(err.error || 'Error', null);
                        } catch (e) {
                            callback('Error', null);
                        }
                    }
                }
            };
            
            xhr.send(data ? JSON.stringify(data) : null);
        }

        function loadSettings() {
            ajax('GET', '/api/settings', null, function(err, data) {
                if (data) {
                    document.getElementById('kindle-email').value = data.kindle_email || '';
                }
            });
        }

        function saveSettings() {
            var data = {
                kindle_email: document.getElementById('kindle-email').value
            };
            
            ajax('POST', '/api/settings', data, function(err, res) {
                if (!err) showToast('Saved');
            });
        }

        function switchTab(tab) {
            currentTab = tab;
            var tabs = ['search', 'cloud', 'queue', 'settings'];
            for (var i = 0; i < tabs.length; i++) {
                document.getElementById('view-' + tabs[i]).className = 'hidden';
                document.getElementById('tab-' + tabs[i] + '-btn').className = '';
            }
            document.getElementById('view-' + tab).className = '';
            document.getElementById('tab-' + tab + '-btn').className = 'active';
            if (tab === 'queue') refreshQueue();
            if (tab === 'cloud') renderOPDSMenu();
        }

        function renderOPDSMenu() {
            var content = document.getElementById('opds-content');
            content.innerHTML = '';
            opdsHistory = [];
            
            var intro = document.createElement('p');
            intro.style.margin = '0 0 15px 0';
            intro.style.color = '#666';
            intro.innerText = 'Select a book from your cloud library to download it to your Kindle.';
            content.appendChild(intro);
            
            var menu = [
                {title: 'Recent Books', path: 'recent', isRecent: true},
                {title: 'Authors', path: '/authors'}
            ];
            
            for (var i = 0; i < menu.length; i++) {
                var div = document.createElement('div');
                div.className = 'opds-item';
                div.innerHTML = '<b>' + menu[i].title + '</b>';
                div.onclick = (function(item) {
                    return function() {
                        if (item.isRecent) {
                            browseRecentBooks();
                        } else {
                            browseOPDS(item.path);
                        }
                    };
                })(menu[i]);
                content.appendChild(div);
            }
        }

        function browseRecentBooks() {
            var content = document.getElementById('opds-content');
            content.innerHTML = '<center>Loading...</center>';
            
            ajax('GET', '/api/opds/browse?url=' + encodeURIComponent('/recent?page=1&size=100'), null, function(err, data) {
                if (err || !data) {
                    content.innerHTML = '<center>Error loading</center>';
                    return;
                }
                
                opdsData = data.entries || [];
                renderRecentBooksList();
            });
        }

        function renderRecentBooksList() {
            var content = document.getElementById('opds-content');
            content.innerHTML = '';
            
            var back = document.createElement('div');
            back.className = 'opds-item';
            back.innerHTML = '<b>&larr; Back</b>';
            back.onclick = function() {
                renderOPDSMenu();
            };
            content.appendChild(back);
            
            var header = document.createElement('div');
            header.className = 'section-header';
            header.innerText = 'Recent Books';
            content.appendChild(header);
            
            // Filter to only books with acquisition links
            var books = [];
            for (var i = 0; i < opdsData.length; i++) {
                var hasAcq = false;
                for (var j = 0; j < opdsData[i].links.length; j++) {
                    if (opdsData[i].links[j].rel && opdsData[i].links[j].rel.indexOf('acquisition') !== -1) {
                        hasAcq = true;
                        break;
                    }
                }
                if (hasAcq) {
                    books.push(opdsData[i]);
                }
            }
            
            if (books.length === 0) {
                content.innerHTML += '<center>No recent books found</center>';
                return;
            }
            
            // Books are already sorted by recent date from OPDS feed
            for (var i = 0; i < books.length; i++) {
                renderBookItem(books[i]);
            }
        }

        function browseOPDS(path) {
            var content = document.getElementById('opds-content');
            content.innerHTML = '<center>Loading...</center>';
            
            var url = path.indexOf('http') === 0 ? path : '';
            var urlParam = url ? '?url=' + encodeURIComponent(url) : '?url=' + encodeURIComponent(path);
            
            ajax('GET', '/api/opds/browse' + urlParam, null, function(err, data) {
                if (err || !data) {
                    content.innerHTML = '<center>Error loading</center>';
                    return;
                }
                
                opdsData = data.entries || [];
                renderOPDSList(path);
            });
        }

        function renderOPDSList(currentPath) {
            var content = document.getElementById('opds-content');
            content.innerHTML = '';
            
            var back = document.createElement('div');
            back.className = 'opds-item';
            back.innerHTML = '<b>&larr; Back</b>';
            back.onclick = function() {
                if (opdsHistory.length === 0) {
                    renderOPDSMenu();
                } else {
                    var prev = opdsHistory.pop();
                    browseOPDS(prev);
                }
            };
            content.appendChild(back);
            
            // Check if this is an author page (has books with acquisition links)
            var hasBooks = false;
            for (var i = 0; i < opdsData.length; i++) {
                for (var j = 0; j < opdsData[i].links.length; j++) {
                    if (opdsData[i].links[j].rel && opdsData[i].links[j].rel.indexOf('acquisition') !== -1) {
                        hasBooks = true;
                        break;
                    }
                }
                if (hasBooks) break;
            }
            
            if (hasBooks) {
                renderAuthorDrilldown();
                return;
            }
            
            // Regular navigation list
            for (var i = 0; i < opdsData.length; i++) {
                var entry = opdsData[i];
                var navLink = null;
                var acqLink = null;
                
                for (var j = 0; j < entry.links.length; j++) {
                    var link = entry.links[j];
                    if (link.rel && link.rel.indexOf('subsection') !== -1) {
                        navLink = link;
                    }
                    if (link.rel && link.rel.indexOf('acquisition') !== -1) {
                        acqLink = link;
                    }
                }
                
                var div = document.createElement('div');
                div.className = 'opds-item';
                
                if (navLink) {
                    div.innerHTML = '<b>' + entry.title + '</b>';
                    div.onclick = (function(path, href) {
                        return function() {
                            opdsHistory.push(path);
                            browseOPDS(href);
                        };
                    })(currentPath, navLink.href);
                } else if (acqLink) {
                    var seriesInfo = '';
                    if (entry.series_name) {
                        seriesInfo = '<br><small>' + entry.series_name + ' #' + (entry.series_index || '?') + '</small>';
                    }
                    div.innerHTML = '<b>' + entry.title + '</b>' + 
                        '<br><small>' + (entry.author || 'Unknown') + '</small>' + 
                        seriesInfo +
                        '<br><button class="btn" style="margin-top:10px; padding:8px;" onclick="sendToKindle(\'' + acqLink.href.replace(/'/g, "\\'") + '\'); event.stopPropagation();">Send to Kindle</button>';
                    div.onclick = null;
                }
                
                content.appendChild(div);
            }
        }

        function renderAuthorDrilldown() {
            var content = document.getElementById('opds-content');
            
            // Collect all unique series
            var seriesMap = {};
            var standaloneBooks = [];
            
            for (var i = 0; i < opdsData.length; i++) {
                var book = opdsData[i];
                if (book.series_name) {
                    if (!seriesMap[book.series_name]) {
                        seriesMap[book.series_name] = [];
                    }
                    seriesMap[book.series_name].push(book);
                } else {
                    standaloneBooks.push(book);
                }
            }
            
            // Show series folders
            var seriesNames = [];
            for (var name in seriesMap) {
                if (seriesMap.hasOwnProperty(name)) {
                    seriesNames.push(name);
                }
            }
            seriesNames.sort();
            
            for (var i = 0; i < seriesNames.length; i++) {
                var sName = seriesNames[i];
                var div = document.createElement('div');
                div.className = 'opds-item';
                div.innerHTML = '<b>ðŸ“š Series: ' + sName + '</b> <small>(' + seriesMap[sName].length + ' books)</small>';
                div.onclick = (function(name, books) {
                    return function() {
                        renderSeriesBooks(name, books);
                    };
                })(sName, seriesMap[sName]);
                content.appendChild(div);
            }
            
            // Show standalone folder
            if (standaloneBooks.length > 0) {
                var div = document.createElement('div');
                div.className = 'opds-item';
                div.innerHTML = '<b>ðŸ“„ Standalone Books</b> <small>(' + standaloneBooks.length + ' books)</small>';
                div.onclick = function() {
                    renderStandaloneBooks(standaloneBooks);
                };
                content.appendChild(div);
            }
            
            // Show all books option
            var div = document.createElement('div');
            div.className = 'opds-item';
            div.innerHTML = '<b>ðŸ“– All Books</b> <small>(' + opdsData.length + ' books)</small>';
            div.onclick = function() {
                renderAllBooks(opdsData);
            };
            content.appendChild(div);
        }

        function renderSeriesBooks(seriesName, books) {
            var content = document.getElementById('opds-content');
            content.innerHTML = '';
            
            var back = document.createElement('div');
            back.className = 'opds-item';
            back.innerHTML = '<b>&larr; Back</b>';
            back.onclick = function() {
                renderOPDSList(opdsHistory[opdsHistory.length - 1] || '');
            };
            content.appendChild(back);
            
            var header = document.createElement('div');
            header.className = 'section-header';
            header.innerText = seriesName;
            content.appendChild(header);
            
            // Sort by series index
            books.sort(function(a, b) {
                return (parseFloat(a.series_index) || 0) - (parseFloat(b.series_index) || 0);
            });
            
            for (var i = 0; i < books.length; i++) {
                renderBookItem(books[i]);
            }
        }

        function renderStandaloneBooks(books) {
            var content = document.getElementById('opds-content');
            content.innerHTML = '';
            
            var back = document.createElement('div');
            back.className = 'opds-item';
            back.innerHTML = '<b>&larr; Back</b>';
            back.onclick = function() {
                renderOPDSList(opdsHistory[opdsHistory.length - 1] || '');
            };
            content.appendChild(back);
            
            var header = document.createElement('div');
            header.className = 'section-header';
            header.innerText = 'Standalone Books';
            content.appendChild(header);
            
            for (var i = 0; i < books.length; i++) {
                renderBookItem(books[i]);
            }
        }

        function renderAllBooks(books) {
            var content = document.getElementById('opds-content');
            content.innerHTML = '';
            
            var back = document.createElement('div');
            back.className = 'opds-item';
            back.innerHTML = '<b>&larr; Back</b>';
            back.onclick = function() {
                renderOPDSList(opdsHistory[opdsHistory.length - 1] || '');
            };
            content.appendChild(back);
            
            var header = document.createElement('div');
            header.className = 'section-header';
            header.innerText = 'All Books';
            content.appendChild(header);
            
            // Sort by title
            books.sort(function(a, b) {
                return a.title.localeCompare(b.title);
            });
            
            for (var i = 0; i < books.length; i++) {
                renderBookItem(books[i]);
            }
        }

        function renderBookItem(book) {
            var content = document.getElementById('opds-content');
            var acqLink = null;
            var thumbnail = '';
            
            for (var j = 0; j < book.links.length; j++) {
                if (book.links[j].rel && book.links[j].rel.indexOf('acquisition') !== -1) {
                    acqLink = book.links[j];
                }
                if (book.links[j].rel && book.links[j].rel.indexOf('thumbnail') !== -1) {
                    thumbnail = book.links[j].href;
                }
            }
            
            if (!acqLink) return;
            
            var div = document.createElement('div');
            div.className = 'opds-item';
            div.style.cursor = 'default';
            
            var seriesInfo = '';
            if (book.series_name) {
                seriesInfo = '<br><small style="color:#666;">' + book.series_name + ' #' + (book.series_index || '?') + '</small>';
            }
            
            var description = '';
            if (book.description) {
                description = '<div class="book-description">' + book.description + '</div>';
            }
            
            var coverHtml = '<div class="book-cover">';
            if (thumbnail) {
                coverHtml += '<img src="' + thumbnail + '" onerror="this.src=\'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTgwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZWVlIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5OTkiIGZvbnQtc2l6ZT0iMTQiPk5vIENvdmVyPC90ZXh0Pjwvc3ZnPg==\';">';
            } else {
                coverHtml += '<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTgwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZWVlIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5OTkiIGZvbnQtc2l6ZT0iMTQiPk5vIENvdmVyPC90ZXh0Pjwvc3ZnPg==">';
            }
            coverHtml += '<button class="btn" onclick="sendToKindle(\'' + acqLink.href.replace(/'/g, "\\'") + '\'); event.stopPropagation();">Send to Kindle</button></div>';
            
            div.innerHTML = '<div class="book-row">' + coverHtml +
                '<div class="book-info">' +
                '<b>' + book.title + '</b>' + seriesInfo + description +
                '</div></div>';
            
            content.appendChild(div);
        }

        function sendToKindle(url) {
            showToast('Sending...');
            ajax('POST', '/api/opds/send-to-kindle', {url: url}, function(err, res) {
                if (err) {
                    showToast('Error: ' + err);
                } else {
                    showToast('Sent to Kindle!');
                }
            });
        }

        function performSearch() {
            var query = document.getElementById('search-input').value;
            if (!query) return;
            
            var results = document.getElementById('search-results');
            results.innerHTML = '<center>Searching...</center>';
            
            ajax('GET', '/api/ephemera/search?q=' + encodeURIComponent(query), null, function(err, data) {
                results.innerHTML = '';
                
                if (err || !data) {
                    results.innerHTML = '<center>Error</center>';
                    return;
                }
                
                if (data.error) {
                    results.innerHTML = '<center>' + data.error + '</center>';
                    return;
                }
                
                if (!data.length) {
                    results.innerHTML = '<center>No results</center>';
                    return;
                }
                
                for (var i = 0; i < data.length; i++) {
                    var book = data[i];
                    var div = document.createElement('div');
                    div.className = 'book-card';
                    div.style.cursor = 'default';
                    
                    var authors = book.authors ? book.authors.join(', ') : 'Unknown';
                    var sizeInMB = book.size ? (book.size / 1024 / 1024).toFixed(1) + ' MB' : 'Unknown size';
                    
                    var coverHtml = '<div class="book-cover">';
                    if (book.coverUrl) {
                        coverHtml += '<img src="' + book.coverUrl + '" onerror="this.src=\'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTgwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZWVlIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5OTkiIGZvbnQtc2l6ZT0iMTQiPk5vIENvdmVyPC90ZXh0Pjwvc3ZnPg==\';">';
                    } else {
                        coverHtml += '<img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTgwIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZWVlIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5OTkiIGZvbnQtc2l6ZT0iMTQiPk5vIENvdmVyPC90ZXh0Pjwvc3ZnPg==">';
                    }
                    coverHtml += '<button class="btn" onclick="addBook(\'' + book.md5 + '\')">Add to Queue</button>';
                    coverHtml += '</div>';
                    
                    div.innerHTML = '<div class="book-row">' + coverHtml +
                        '<div class="book-info">' +
                        '<b>' + book.title + '</b>' +
                        '<br><small style="color:#666;">' + authors + '</small>' +
                        '<br><small style="color:#666;">Language: ' + (book.language || 'Unknown') + ' â€¢ Size: ' + sizeInMB + '</small>' +
                        '</div></div>';
                    
                    results.appendChild(div);
                }
            });
        }

        function addBook(md5) {
            ajax('POST', '/api/ephemera/download', {md5: md5, title: ''}, function(err, res) {
                if (!err) showToast('Queued');
            });
        }

        function refreshQueue() {
            if (currentTab !== 'queue') return;
            
            var list = document.getElementById('queue-list');
            list.innerHTML = '<center>Loading...</center>';
            
            ajax('GET', '/api/ephemera/queue', null, function(err, res) {
                list.innerHTML = '';
                
                if (err || !res) {
                    list.innerHTML = '<center>Error</center>';
                    return;
                }
                
                if (res.error && typeof res.error === 'string') {
                    list.innerHTML = '<center>' + res.error + '</center>';
                    return;
                }
                
                var allItems = [];
                var categories = ['queued', 'downloading', 'done', 'error', 'delayed', 'cancelled', 'available'];
                
                for (var i = 0; i < categories.length; i++) {
                    var cat = categories[i];
                    if (res[cat]) {
                        for (var md5 in res[cat]) {
                            if (res[cat].hasOwnProperty(md5)) {
                                var item = res[cat][md5];
                                item.status = cat;
                                allItems.push(item);
                            }
                        }
                    }
                }
                
                if (allItems.length === 0) {
                    list.innerHTML = '<center>Queue empty</center>';
                    return;
                }

                for (var i = 0; i < allItems.length; i++) {
                    var item = allItems[i];
                    var div = document.createElement('div');
                    div.className = 'queue-item';
                    div.innerHTML = '<b>' + (item.title || item.filename || 'Unknown') + '</b><br>' +
                        '<small>Status: ' + item.status + '</small>';
                    list.appendChild(div);
                }
            });
        }

        loadSettings();
        renderOPDSMenu();
    </script>
</body>
</html>
